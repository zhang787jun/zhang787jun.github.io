<!DOCTYPE HTML>
<html>

<head>
    <link rel="Stylesheet" type="text/css" href="/Wiki/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/Wiki/static/css/tango.css">
    <link rel="shortcut icon" href="/Wiki/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/Wiki/favicon.ico" type="image/x-icon">
    <title>从聊天室的实现看网络通讯 - Jun's personal knowledge wiki</title>
    <meta name="keywords" content="Technology, MachineLearning, DataMining, Wiki" />
    <meta name="description" content="A wiki website" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
            }
        });
    </script>
    <script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
        </script>
</head>

<body>

    <div id="container">
        
<div id="header">
  <div id="post-nav"><a href="/Wiki/">Home</a>&nbsp;»&nbsp;<a href="/Wiki/#Basic_CS">Basic_CS</a>&nbsp;»&nbsp;<a href="/Wiki/#-Network">Network</a>&nbsp;»&nbsp;<a href="/Wiki/#-基于ISO模型通信笔记分类">基于ISO模型通信笔记分类</a>&nbsp;»&nbsp;从聊天室的实现看网络通讯</div>
</div>
<div class="clearfix"></div>
<div id="title">从聊天室的实现看网络通讯</div>
<div id="content">
  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#_1">从聊天室的实现看网络通讯</a><ul>
<li><a href="#0pre">0.Pre</a><ul>
<li><a href="#0-socket">0. socket编程思路</a></li>
</ul>
</li>
<li><a href="#1">1. 聊天室单工实现</a></li>
<li><a href="#2">2. 聊天室半双工实现：</a></li>
<li><a href="#3-p2p">3. 聊天室全双工(P2P)实现：</a></li>
<li><a href="#4-p2m">4. 聊天室全双工(P2M)实现：</a></li>
<li><a href="#5-p2m-websocket">5. 聊天室全双工(P2M) WebSocket 实现：</a></li>
</ul>
</li>
</ul>
</div>
<h1 id="_1">从聊天室的实现看网络通讯</h1>
<h2 id="0pre">0.Pre</h2>
<h3 id="0-socket">0. socket编程思路</h3>
<p>TCP服务端：</p>
<p>1 创建套接字，绑定套接字到本地IP与端口</p>
<div class="hlcode"><pre><span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">bind</span><span class="p">()</span>
</pre></div>


<p>2 开始监听连接</p>
<div class="hlcode"><pre><span class="n">s</span><span class="p">.</span><span class="n">listen</span><span class="p">()</span>
</pre></div>


<p>3 进入循环，不断接受客户端的连接请求</p>
<div class="hlcode"><pre><span class="k">while</span> <span class="n">True</span><span class="o">:</span>
    <span class="n">s</span><span class="p">.</span><span class="n">accept</span><span class="p">()</span>
</pre></div>


<p>4 然后接收传来的数据，并发送给对方数据</p>
<div class="hlcode"><pre><span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span> 
<span class="n">s</span><span class="p">.</span><span class="n">sendall</span><span class="p">()</span>
</pre></div>


<p>5 传输完毕后，关闭套接字</p>
<div class="hlcode"><pre><span class="n">s</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>


<p>TCP客户端:</p>
<p>1 创建套接字，连接远端地址</p>
<div class="hlcode"><pre><span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> 
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">()</span>
</pre></div>


<p>2 连接后发送数据和接收数据</p>
<div class="hlcode"><pre><span class="n">s</span><span class="p">.</span><span class="n">sendall</span><span class="p">()</span>
<span class="n">s</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>
</pre></div>


<p>3 传输完毕后，关闭套接字 </p>
<div class="hlcode"><pre><span class="n">s</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>


<h2 id="1">1. 聊天室单工实现</h2>
<p>单工版非常简单，只能客户端单方面向服务端发消息，服务端回复固定模板消息。</p>
<p>只能我发消息，对方固定返回东西<br />
<strong>1. Server</strong></p>
<div class="hlcode"><pre><span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">tcplink</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;Accept new connection from </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">...&#39;</span> <span class="o">%</span> <span class="n">addr</span>
    <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;Welcome!&#39;</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s">&#39;exit&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;Hello, </span><span class="si">%s</span><span class="s">!&#39;</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">print</span> <span class="s">&#39;Connection from </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s"> closed.&#39;</span> <span class="o">%</span> <span class="n">addr</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">9999</span><span class="p">))</span>
<span class="c"># 等待队列长度5，如果系统可以并发处理100个请求，同时到达106个请求，100个请求直接被处理，5个等待，第106个直接就拒绝</span>
<span class="n">s</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&#39;Waiting for connection...&#39;</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="c"># 接受一个新连接:</span>
    <span class="n">sock</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
    <span class="c"># 创建新线程来处理TCP连接:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">tcplink</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>


<p>Client:</p>
<div class="hlcode"><pre><span class="c"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">socket</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="c"># 建立连接:</span>
<span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">9999</span><span class="p">))</span>
<span class="c"># 接收欢迎消息:</span>
<span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Michael&#39;</span><span class="p">,</span> <span class="s">&#39;Tracy&#39;</span><span class="p">,</span> <span class="s">&#39;Sarah&#39;</span><span class="p">]:</span>
    <span class="c"># 发送数据:</span>
    <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;exit&#39;</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>


<p>此为最基础的基于TCP协议的聊天程序，实现了Socket编程的主要流程。</p>
<p>服务器进程<br />
1. 首先要绑定一个端口并监听来自其他客户端的连接。如果某个客户端连接过来了，服务器就与该客户端建立Socket连接，随后的通信就靠这个Socket连接了。<br />
2.所以，服务器会打开固定端口（比如80）监听，每来一个客户端连接，就创建该Socket连接。由于服务器会有大量来自客户端的连接，所以，服务器要能够区分一个Socket连接是和哪个客户端绑定的。一个Socket依赖4项：服务器地址、服务器端口、客户端地址、客户端端口来唯一确定一个Socket。<br />
但是服务器还需要同时响应多个客户端的请求，所以，每个连接都需要一个新的进程或者新的线程来处理，否则，服务器一次就只能服务一个客户端了。</p>
<h2 id="2">2. 聊天室半双工实现：</h2>
<p>和一个人聊天 只能你一句，我一句，不能我连续发两句。</p>
<p>你可以发消息给我，我也可以发消息给你，不能同时发送</p>
<p><strong>半双工(Half Duplex)</strong>:数据传输指数据可以在一个信号载体的两个方向上传输，但是不能同时传输。<br />
半双工实现是连接建立以后，服务器等待客户端发送消息，客户端发送消息后等待接收服务器，这样一来一回循环往复下去。直到出现quit，关闭连接。</p>
<p>Server:</p>
<div class="hlcode"><pre><span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">ctime</span>

<span class="n">HOST</span> <span class="o">=</span> <span class="s">&#39;localhost&#39;</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">3300</span>
<span class="n">BUSIZ</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">ADDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">closeTCnt</span><span class="p">():</span>
    <span class="n">TCntSock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">print</span> <span class="s">&quot;Session closing..&quot;</span>

<span class="c"># 1.连接</span>
<span class="n">TSerSock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">TSerSock</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">ADDR</span><span class="p">)</span>
<span class="c"># 2.监听</span>
<span class="n">TSerSock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="c"># 3. 循环</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">&#39;Waitting for connection...&#39;</span><span class="p">)</span>
        <span class="p">(</span><span class="n">TCntSock</span><span class="p">,</span> <span class="n">cntAddr</span><span class="p">)</span> <span class="o">=</span> <span class="n">TSerSock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">&#39;...connection from:{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cntAddr</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">rData</span> <span class="o">=</span> <span class="n">TCntSock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BUSIZ</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">rData</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">rData</span> <span class="o">==</span> <span class="s">&#39;quit&#39;</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="p">(</span><span class="s">&#39;From [</span><span class="si">%s</span><span class="s">] </span><span class="si">%s</span><span class="s"> </span><span class="se">\n</span><span class="s">  </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cntAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ctime</span><span class="p">(),</span> <span class="n">rData</span><span class="p">))</span>

                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">sData</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;&gt;  &#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sData</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">TCntSock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;From [</span><span class="si">%s</span><span class="s">] </span><span class="si">%s</span><span class="s"> </span><span class="se">\n</span><span class="s">  </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                                      <span class="p">(</span><span class="n">cntAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ctime</span><span class="p">(),</span> <span class="n">sData</span><span class="p">))</span>
                        <span class="k">break</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">detail</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">detail</span>
        <span class="n">closeTCnt</span><span class="p">()</span>

<span class="k">finally</span><span class="p">:</span>
    <span class="n">TSerSock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>


<p>Client:</p>
<div class="hlcode"><pre><span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="n">HOST</span> <span class="o">=</span> <span class="s">&#39;localhost&#39;</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">3300</span>
<span class="n">BUFSIZ</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">ADDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
<span class="n">tryCon</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">TCnt</span><span class="p">():</span>
    <span class="n">tcpCliSock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tcpCliSock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">ADDR</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">u&quot;正在尝试连接远程主机 &quot;</span>
            <span class="k">global</span> <span class="n">tryCon</span>
            <span class="n">tryCon</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">tryCon</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">u&quot;无法连接上远程主机，请稍后再试&quot;</span>
                <span class="nb">exit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">print</span> <span class="s">u&#39;登陆成功（通讯结束请输入&quot;quit&quot;退出）</span><span class="se">\n</span><span class="s">&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;&gt;  &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s">&#39;quit&#39;</span><span class="p">:</span>
                <span class="n">tcpCliSock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tcpCliSock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">tcpCliSock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BUFSIZ</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="n">data</span>
                    <span class="k">break</span>
    <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Session closing&quot;</span>
        <span class="k">print</span> <span class="n">e</span>
    <span class="n">tcpCliSock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">TCnt</span><span class="p">()</span>
</pre></div>


<p>这里就出现了一个有趣的问题，为什么这段代码只能一来一回的发送消息呢？讲道理应该发完消息不应该可以接着发消息吗？凭什么发了一条消息必须等待另一端发消息回来才能继续发？这就引出了全双工实现的原理。</p>
<h2 id="3-p2p">3. 聊天室全双工(P2P)实现：</h2>
<p>和一个人聊天 且可以连续发消息</p>
<p>因为TCP连接是一个流，所以Socket模块的recv()是直到Scoket连接终断不会停止等待接受从另一端发送的消息的。全双工实现比半双工工多了个线程处理，所以<strong>服务器与客户端必须开两个线程，一个收消息一个发消息</strong>，并且<strong>发消息的线程需要阻塞收消息的线程</strong>。</p>
<p>Server:</p>
<div class="hlcode"><pre><span class="c"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">ctime</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="n">HOST</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">9999</span>
<span class="n">BUFSIZ</span> <span class="o">=</span> <span class="mi">1024</span> <span class="c"># 系统默认的缓冲区大小,内存缓冲</span>
<span class="n">ADDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>

<span class="n">tcpSerSock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">tcpSerSock</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">ADDR</span><span class="p">)</span>
<span class="n">tcpSerSock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="n">clients</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c"># key:value={username:socket}</span>
<span class="n">chatwith</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c"># key:value={user1.socket: user2.socket}</span>


<span class="c"># clients字典中记录了连接的客户端的用户名和套接字的对应关系</span>
<span class="c"># chatwith字典中记录了通信双方的套接字的对应</span>

<span class="c"># messageTransform()处理客户端确定用户名之后发送的文本</span>
<span class="c"># 文本只有四种类型：</span>
<span class="c">#   None</span>
<span class="c">#   Quit</span>
<span class="c">#   To:someone</span>
<span class="c">#   其他文本</span>
<span class="k">def</span> <span class="nf">messageTransform</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BUFSIZ</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">chatwith</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">sock</span><span class="p">):</span>
                <span class="n">chatwith</span><span class="p">[</span><span class="n">sock</span><span class="p">]</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">chatwith</span><span class="p">[</span><span class="n">chatwith</span><span class="p">[</span><span class="n">sock</span><span class="p">]]</span> <span class="c"># 删除聊天连接中的接收者</span>
                <span class="k">del</span> <span class="n">chatwith</span><span class="p">[</span><span class="n">sock</span><span class="p">]</span> <span class="c"># 删除聊天连接中的发送者</span>
            <span class="k">del</span> <span class="n">clients</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="c"># 删除用户信息</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s">&#39;Quit&#39;</span><span class="p">:</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">chatwith</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">sock</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="n">data</span>
                <span class="n">chatwith</span><span class="p">[</span><span class="n">sock</span><span class="p">]</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">chatwith</span><span class="p">[</span><span class="n">chatwith</span><span class="p">[</span><span class="n">sock</span><span class="p">]]</span>
                <span class="k">del</span> <span class="n">chatwith</span><span class="p">[</span><span class="n">sock</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">clients</span><span class="p">[</span><span class="n">user</span><span class="p">]</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;^To:.+&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">clients</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="n">user</span><span class="p">:</span>
                    <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;Please don</span><span class="se">\&#39;</span><span class="s">t try to talk with yourself.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">chatwith</span><span class="p">[</span><span class="n">sock</span><span class="p">]</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="n">data</span><span class="p">]</span>
                    <span class="n">chatwith</span><span class="p">[</span><span class="n">clients</span><span class="p">[</span><span class="n">data</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sock</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;the user </span><span class="si">%s</span><span class="s"> is not exist&#39;</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">chatwith</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">sock</span><span class="p">):</span>
                <span class="n">chatwith</span><span class="p">[</span><span class="n">sock</span><span class="p">]</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;[</span><span class="si">%s</span><span class="s">] </span><span class="si">%s</span><span class="s">: (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ctime</span><span class="p">(),</span> <span class="n">user</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;Nobody is chating with you. Maybe the one talked with you is talking with someone else&#39;</span><span class="p">)</span>


<span class="c"># 每个客户端连接之后，都会启动一个新线程</span>
<span class="c"># 连接成功后需要输入用户名</span>
<span class="c"># 输入的用户名可能会：</span>
<span class="c">#   已存在</span>
<span class="c">#   (客户端直接输入ctrl+c退出)</span>
<span class="c">#   合法用户名</span>
<span class="k">def</span> <span class="nf">connectThread</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">test</span><span class="p">):</span>  <span class="c"># client&#39;s socket</span>

    <span class="n">user</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>  <span class="c"># receive the username</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BUFSIZ</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span><span class="p">:</span>  <span class="c"># the client logout without input a name</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;The client logout without input a name&#39;</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">clients</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>  <span class="c"># username existed</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;Reuse&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c"># correct username</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;OK&#39;</span><span class="p">)</span>
            <span class="n">clients</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="n">sock</span>  <span class="c"># username -&gt; socket</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">username</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;The username is: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">user</span><span class="p">)</span>
    <span class="c"># get the correct username</span>

    <span class="n">messageTransform</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;...WAITING FOR CONNECTION&#39;</span><span class="p">)</span>
        <span class="n">tcpCliSock</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">tcpSerSock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;CONNECTED FROM: &#39;</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
        <span class="n">chat</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">connectThread</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">tcpCliSock</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="n">chat</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>


<p>Client:</p>
<div class="hlcode"><pre><span class="c"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="n">HOST</span> <span class="o">=</span> <span class="s">&#39;127.0.0.1&#39;</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">9999</span>
<span class="n">BUFSIZ</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">ADDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>

<span class="n">tcpCliSock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">tcpCliSock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">ADDR</span><span class="p">)</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">因为每个客户端接收消息和发送消息是相互独立的，</span>
<span class="sd">所以这里将两者分开，开启两个线程处理</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="k">def</span> <span class="nf">Send</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">test</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">()</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s">&#39;Quit&#39;</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;Quit&#39;</span><span class="p">)</span>
            <span class="k">break</span>


<span class="k">def</span> <span class="nf">Recv</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">test</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BUFSIZ</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s">&#39;Quit.&#39;</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;He/She logout&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s">&#39;Quit&#39;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;         </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Successful connection&#39;</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">username</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;Your name(press only Enter to quit): &#39;</span><span class="p">)</span>
        <span class="n">tcpCliSock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="c"># username is not None</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">tcpCliSock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BUFSIZ</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="s">&#39;Reuse&#39;</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;The name is reuse, please set a new one&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Welcome! </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">username</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span><span class="p">:</span>
        <span class="n">tcpCliSock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">recvMessage</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">Recv</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">tcpCliSock</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
    <span class="n">sendMessage</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">Send</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">tcpCliSock</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
    <span class="n">sendMessage</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">recvMessage</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">sendMessage</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">recvMessage</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>


<p>这里的实现逻辑是，每当一个客户端连接进服务端，客户端需要向服务端申请一个ID，服务端将这个ID与客户端连接的Socket对象存入字典，然后监听客户端向服务端发出的消息中有没有”To:”如果有就取出至三个字符后的字符，与字典中的key去比对，如果有存在的ID(不能是当前客户端自己的ID)，就将这两个Socket对象存入一个chatwith的字典中。实现A客户端发消息给服务端，服务端从chatwith字典中查询当前客户端对应的连接，再将A客户端的消息发送给连接的B客户端。</p>
<h2 id="4-p2m">4. 聊天室全双工(P2M)实现：</h2>
<p>群聊 连续发送</p>
<p>不过这里出现了一个问题，如果客户端A在和B聊天的过程中，进来了一个客户端C。客户端C也想加入AB的聊天，但是我们的服务端将C的Socket对象覆盖掉了B的，于是B发送什么消息A都接受不到了，而A发的消息只有C能收到了。</p>
<p>这里通过广播(P2M)的形式解决。</p>
<p>这里稍微修改了P2P实现的服务端逻辑，不在将Socket连接一一对应，而是将所有的Socket连接存入一个列表，每当一个客户端发送消息，服务端就将这段消息广播给所有的客户端。</p>
<p>Server:</p>
<div class="hlcode"><pre><span class="c"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">socket</span><span class="o">,</span> <span class="nn">select</span>

<span class="n">host</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">8080</span>
<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

<span class="n">inputs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">fd_name</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">who_in_room</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
    <span class="n">name_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">w</span><span class="p">:</span>
        <span class="n">name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">name_list</span>

<span class="k">def</span> <span class="nf">conn</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">&#39;...WAITING FOR CONNECTION&#39;</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
    <span class="n">ss</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
    <span class="n">ss</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ss</span>

<span class="k">def</span> <span class="nf">new_coming</span><span class="p">(</span><span class="n">ss</span><span class="p">):</span>
    <span class="n">client</span><span class="p">,</span> <span class="n">add</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
    <span class="k">print</span> <span class="s">&#39;welcome </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">add</span><span class="p">)</span>
    <span class="n">wel</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;&#39;&#39;Your name(press only Enter to quit): &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">wel</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
        <span class="n">fd_name</span><span class="p">[</span><span class="n">client</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

        <span class="n">nameList</span> <span class="o">=</span> <span class="s">&quot;Some people in talking room, these are </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">who_in_room</span><span class="p">(</span><span class="n">fd_name</span><span class="p">))</span>
        <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">nameList</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">e</span>

<span class="k">def</span> <span class="nf">server_run</span><span class="p">():</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">conn</span><span class="p">()</span>
    <span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">temp</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">temp</span> <span class="ow">is</span> <span class="n">ss</span><span class="p">:</span>
                <span class="n">new_coming</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">disconnect</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">fd_name</span><span class="p">[</span><span class="n">temp</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; say : &#39;</span> <span class="o">+</span> <span class="n">data</span>
                <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">fd_name</span><span class="p">[</span><span class="n">temp</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; leave the room&#39;</span>
                    <span class="n">disconnect</span> <span class="o">=</span> <span class="bp">True</span>

                <span class="k">if</span> <span class="n">disconnect</span><span class="p">:</span>
                    <span class="n">inputs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
                    <span class="k">print</span> <span class="n">data</span>
                    <span class="k">for</span> <span class="n">other</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">other</span> <span class="o">!=</span> <span class="n">ss</span> <span class="ow">and</span> <span class="n">other</span> <span class="o">!=</span> <span class="n">temp</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">other</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                                <span class="k">print</span> <span class="n">e</span>
                    <span class="k">del</span> <span class="n">fd_name</span><span class="p">[</span><span class="n">temp</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="n">data</span>

                    <span class="k">for</span> <span class="n">other</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">other</span> <span class="o">!=</span> <span class="n">ss</span> <span class="ow">and</span> <span class="n">other</span> <span class="o">!=</span> <span class="n">temp</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">other</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                                <span class="k">print</span> <span class="n">e</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">server_run</span><span class="p">()</span>
</pre></div>


<p>Client:</p>
<div class="hlcode"><pre><span class="c"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">socket</span><span class="o">,</span> <span class="nn">select</span><span class="o">,</span> <span class="nn">threading</span>

<span class="n">host</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>

<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">8080</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">conn</span><span class="p">():</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>

<span class="k">def</span> <span class="nf">lis</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">my</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">my</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;socket is error&#39;</span>
                <span class="nb">exit</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">talk</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;can</span><span class="se">\&#39;</span><span class="s">t input&#39;</span>
            <span class="nb">exit</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">e</span>
            <span class="nb">exit</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">conn</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">lis</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">ss</span><span class="p">,))</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">talk</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">ss</span><span class="p">,))</span>
    <span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>


<h2 id="5-p2m-websocket">5. 聊天室全双工(P2M) WebSocket 实现：</h2>
<p>这里又有一个奇思妙想出现了，因为在学习Socket编程的时候接触到了一个叫WebSocket的好玩的东西，于是实现了一个以浏览器为客户端的聊天室程序。使用Nodejs编写聊天室不仅代码简洁优雅功能强大，并且逼格都高很多。</p>
<p>此处以node.js + nodejs-websocket实现，首先需要安装Node.js和这个第三方模块</p>
<p>Server:</p>
<div class="hlcode"><pre><span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;nodejs-websocket&quot;</span><span class="p">)</span>

<span class="kd">var</span> <span class="nx">clientCount</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1">// Scream server example: &quot;hi&quot; -&gt; &quot;HI!!!&quot;</span>
<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">ws</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">conn</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;New connection&quot;</span><span class="p">)</span>
    <span class="nx">clientCount</span><span class="o">++</span>
    <span class="nx">conn</span><span class="p">.</span><span class="nx">nickname</span> <span class="o">=</span> <span class="s1">&#39;user&#39;</span> <span class="o">+</span> <span class="nx">clientCount</span>
    <span class="nx">broadcast</span><span class="p">(</span><span class="nx">conn</span><span class="p">.</span><span class="nx">nickname</span> <span class="o">+</span> <span class="s1">&#39; comes in&#39;</span><span class="p">)</span>
    <span class="nx">conn</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Received &quot;</span><span class="o">+</span><span class="nx">str</span><span class="p">)</span>
        <span class="nx">broadcast</span><span class="p">(</span><span class="nx">conn</span><span class="p">.</span><span class="nx">nickname</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">str</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">conn</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">reason</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Connection closed&quot;</span><span class="p">)</span>
        <span class="nx">broadcast</span><span class="p">(</span><span class="nx">conn</span><span class="p">.</span><span class="nx">nickname</span> <span class="o">+</span> <span class="s1">&#39; left&#39;</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">conn</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;handle err&quot;</span><span class="p">)</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">8001</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connect is close&quot;</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">broadcast</span><span class="p">(</span><span class="nx">str</span><span class="p">){</span>
    <span class="nx">server</span><span class="p">.</span><span class="nx">connections</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">){</span>
        <span class="nx">connection</span><span class="p">.</span><span class="nx">sendText</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">}</span>
</pre></div>


<p>Client:</p>
<div class="hlcode"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;title&gt;</span>WebSocket<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Chat Room<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;sendTxt&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">&quot;sendBtn&quot;</span><span class="nt">&gt;</span>发送<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
        <span class="kd">var</span> <span class="nx">websocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s2">&quot;ws://localhost:8001/&quot;</span><span class="p">);</span>
        <span class="kd">function</span> <span class="nx">showMessage</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
            <span class="nx">div</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">str</span><span class="p">;</span>
            <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">div</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">websocket</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;websocket open&quot;</span><span class="p">);</span>
            <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;sendBtn&quot;</span><span class="p">).</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
                <span class="kd">var</span> <span class="nx">txt</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;sendTxt&quot;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">txt</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">websocket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">txt</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">websocket</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;websocket close&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">websocket</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
            <span class="nx">showMessage</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>


<p>websocket</p>
<p>一、需要注意的是，js建立连接处完整的js代码要执行完成退出后才会真正发起建立连接请求，如果在此之前发送消息则会报错如下：</p>
<p>InvalidStateError: An attempt was made to use an object that is not, or is no longer, usable</p>
<p>解决办法：在websocket已经和Workerman链接的时候再发送消息，而不是在建立链接之前去发送消息</p>
<p>websocket.onopen = function (evt) <br />
{<br />
   bindUid(websocket);<br />
};</p>
<p>var data = {<br />
       'type': '4001',<br />
       'user_id': response.user_id<br />
}<br />
websocket.send(JSON.stringify(data)); //这里给Workerman发送信息的时候一定要转换成字符串，不然那边识别了</p>
<p>二、Workerman那边广播消息的时候返回的是一个Json字符串，所以在HTML代码中可以通过把字符串转换成对象来获取值比较容易点：<br />
复制代码</p>
<p>function onMessage(evt)<br />
    {<br />
        var $json_obj = JSON.parse(evt.data); //由JSON字符串转换为JSON对象<br />
        if ($json_obj.error_code == 200) {<br />
            alert($json_obj.message);<br />
        }<br />
        console.log($json_obj);<br />
    }</p>
<p>复制代码</p>
</div>
<div id="renote">
  <HR style=" FILTER: alpha (opacity = 100, finishopacity =0 , style= 3 )" width="80%" color=#987 cb 9 SIZE=3>
  <p>如果你觉得这篇文章对你有帮助，不妨请我喝杯咖啡，鼓励我创造更多!</p>
  <img src="/Wiki/static/images/pay.jpg" width="25%">
</div>

    </div>
    <div id="footer">
        <span>
            Copyright © 2021 zhang787jun.
            Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
        </span>
    </div>

    
</body>
<script>
    function changeImgurl(site_root_url) {
        var images = document.images;
        var site_root = site_root_url;
        for (i = 0, len = images.length; i < len; i++) {
            image = images[i];
            image_src = image.src;
            if (image_src.search("attach") >= 0) {
                re_image_src = image_src.slice(image_src.search("attach"));
                abs_image_src = (site_root.endsWith("/")) ? site_root + re_image_src : site_root + "/" +
                    re_image_src;
                image.src = abs_image_src;
            }
        }
    }
    var site_root_url = "/Wiki";
    changeImgurl(site_root_url);
    let isMathjaxConfig = false; // 防止重复调用Config，造成性能损耗
    const initMathjaxConfig = () => {
        if (!window.MathJax) {
            return;
        }
        window.MathJax.Hub.Config({
            showProcessingMessages: false, //关闭js加载过程信息
            messageStyle: "none", //不显示信息
            jax: ["input/TeX", "output/HTML-CSS"],
            tex2jax: {
                inlineMath: [["$", "$"], ["\\(", "\\)"]], //行内公式选择符
                displayMath: [["$$", "$$"], ["\\[", "\\]"]], //段内公式选择符
                skipTags: ["script", "noscript", "style", "textarea", "pre", "code", "a"] //避开某些标签
            },
            "HTML-CSS": {
                availableFonts: ["STIX", "TeX"], //可选字体
                showMathMenu: false //关闭右击菜单显示
            }
        });
        isMathjaxConfig = true; //
    };
    if (isMathjaxConfig === false) {
        // 如果：没有配置MathJax
        initMathjaxConfig();
    };
</script>

</html>