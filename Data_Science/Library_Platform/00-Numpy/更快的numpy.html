<!DOCTYPE HTML>
<html>

<head>
    <link rel="Stylesheet" type="text/css" href="/Wiki/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/Wiki/static/css/tango.css">
    <link rel="shortcut icon" href="/Wiki/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/Wiki/favicon.ico" type="image/x-icon">
    <title>为了更快的Numpy - Jun's personal knowledge wiki</title>
    <meta name="keywords" content="Technology, MachineLearning, DataMining, Wiki" />
    <meta name="description" content="A wiki website" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
            }
        });
    </script>
    <script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
        </script>
</head>

<body>

    <div id="container">
        
<div id="header">
  <div id="post-nav"><a href="/Wiki/">Home</a>&nbsp;»&nbsp;<a href="/Wiki/#Data_Science">Data_Science</a>&nbsp;»&nbsp;<a href="/Wiki/#-Library_Platform">Library_Platform</a>&nbsp;»&nbsp;<a href="/Wiki/#-00-Numpy">00-Numpy</a>&nbsp;»&nbsp;为了更快的Numpy</div>
</div>
<div class="clearfix"></div>
<div id="title">为了更快的Numpy</div>
<div id="content">
  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#1-numpy">1. 更快的 numpy</a><ul>
<li><a href="#11-mkl">1.1. mkl 加速</a></li>
<li><a href="#12">1.2. 多维数据在内存的形式</a></li>
<li><a href="#13-copy-vs-view">1.3. 数组选择copy Vs view</a></li>
<li><a href="#14-out">1.4. 使用 out 参数</a></li>
<li><a href="#15-gpu">1.5. GPU</a></li>
</ul>
</li>
<li><a href="#numpy">用好numpy</a></li>
<li><a href="#2-numpy">2. 更小的numpy</a></li>
<li><a href="#3">3. 测试</a></li>
<li><a href="#4">4. 参考资料</a></li>
</ul>
</div>
<p>如何使用numpy，使得其在计算时更快？ </p>
<h1 id="1-numpy">1. 更快的 numpy</h1>
<h2 id="11-mkl">1.1. mkl 加速</h2>
<p><img alt="" src="/attach/images/2019-10-27-13-56-37.png" /></p>
<p>Numpy 的许多函数不仅是用C实现了，还使用了BLAS(Basic Linear Algebra Subprograms，基础线性代数程序集)（一般Windows下link到MKL的，Linux下link到OpenBLAS）。基本上那些BLAS实现在每种操作上都进行了高度优化，例如使用AVX向量指令集，甚至能比你自己用C实现快上许多，更不要说和用Python实现的比</p>
<p>英特尔数学核心库(Intel MKL) 的开发是致力于加速在intel处理器上进行的数学运算。该库支持 Windows、Linux和 macOS 操作系统。</p>
<p>在安装 NumPy 的时候，为了速度更快，我们可以安装带 mkl 的版本。</p>
<p><strong>安装</strong><br />
可以通过以下方式安装：<br />
1. conda，<br />
2. 下载二进制whl文件，（Unofficial Windows Binaries for Python Extension Packages, <a href="https://www.lfd.uci.edu/~gohlke/pythonlibs/#scipy">地址</a>）</p>
<div class="hlcode"><pre><span class="n">pip</span> <span class="n">install</span> <span class="n">intel</span><span class="o">-</span><span class="n">numpy</span>

<span class="n">conda</span> <span class="n">install</span> <span class="n">numpy</span> <span class="err">#</span> <span class="n">conda</span> <span class="err">版本已经是优化过的</span> <span class="n">Anoconda</span> <span class="err">（</span><span class="n">base</span><span class="err">）环境里面已经安装过</span> 
</pre></div>


<p><strong>查看</strong></p>
<div class="hlcode"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span> 
<span class="n">np</span><span class="o">.</span><span class="n">show_config</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="c"># No MKL</span>
<span class="n">blas_mkl_info</span><span class="p">:</span>
  <span class="n">NOT</span> <span class="n">AVAILABLE</span>
<span class="n">blis_info</span><span class="p">:</span>
  <span class="n">NOT</span> <span class="n">AVAILABLE</span>
<span class="n">openblas_info</span><span class="p">:</span>
    <span class="n">library_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;C:</span><span class="se">\\</span><span class="s">projects</span><span class="se">\\</span><span class="s">numpy-wheels</span><span class="se">\\</span><span class="s">numpy</span><span class="se">\\</span><span class="s">build</span><span class="se">\\</span><span class="s">openblas&#39;</span><span class="p">]</span>
    <span class="n">libraries</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;openblas&#39;</span><span class="p">]</span>
    <span class="n">language</span> <span class="o">=</span> <span class="n">f77</span>
    <span class="n">define_macros</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;HAVE_CBLAS&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)]</span>
<span class="n">blas_opt_info</span><span class="p">:</span>
    <span class="n">library_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;C:</span><span class="se">\\</span><span class="s">projects</span><span class="se">\\</span><span class="s">numpy-wheels</span><span class="se">\\</span><span class="s">numpy</span><span class="se">\\</span><span class="s">build</span><span class="se">\\</span><span class="s">openblas&#39;</span><span class="p">]</span>
    <span class="n">libraries</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;openblas&#39;</span><span class="p">]</span>
    <span class="n">language</span> <span class="o">=</span> <span class="n">f77</span>
    <span class="n">define_macros</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;HAVE_CBLAS&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)]</span>
<span class="n">lapack_mkl_info</span><span class="p">:</span>
  <span class="n">NOT</span> <span class="n">AVAILABLE</span>
<span class="n">openblas_lapack_info</span><span class="p">:</span>
    <span class="n">library_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;C:</span><span class="se">\\</span><span class="s">projects</span><span class="se">\\</span><span class="s">numpy-wheels</span><span class="se">\\</span><span class="s">numpy</span><span class="se">\\</span><span class="s">build</span><span class="se">\\</span><span class="s">openblas&#39;</span><span class="p">]</span>
    <span class="n">libraries</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;openblas&#39;</span><span class="p">]</span>
    <span class="n">language</span> <span class="o">=</span> <span class="n">f77</span>
    <span class="n">define_macros</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;HAVE_CBLAS&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)]</span>
<span class="n">lapack_opt_info</span><span class="p">:</span>
    <span class="n">library_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;C:</span><span class="se">\\</span><span class="s">projects</span><span class="se">\\</span><span class="s">numpy-wheels</span><span class="se">\\</span><span class="s">numpy</span><span class="se">\\</span><span class="s">build</span><span class="se">\\</span><span class="s">openblas&#39;</span><span class="p">]</span>
    <span class="n">libraries</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;openblas&#39;</span><span class="p">]</span>
    <span class="n">language</span> <span class="o">=</span> <span class="n">f77</span>
    <span class="n">define_macros</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;HAVE_CBLAS&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)]</span>

<span class="c"># with mkl</span>
<span class="n">mkl_info</span><span class="p">:</span>
    <span class="n">libraries</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;mkl_rt&#39;</span><span class="p">]</span>
    <span class="n">library_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;D:/ProgramData/Anaconda3</span><span class="se">\\</span><span class="s">Library</span><span class="se">\\</span><span class="s">lib&#39;</span><span class="p">]</span>
    <span class="n">define_macros</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;SCIPY_MKL_H&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;HAVE_CBLAS&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)]</span>
    <span class="n">include_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;C:</span><span class="se">\\</span><span class="s">Program Files (x86)</span><span class="se">\\</span><span class="s">IntelSWTools</span><span class="se">\\</span><span class="s">compilers_and_libraries_2019.0.117</span><span class="se">\\</span><span class="s">windows</span><span class="se">\\</span><span class="s">mkl&#39;</span><span class="p">,</span> <span class="s">&#39;C:</span><span class="se">\\</span><span class="s">Program Files (x86)</span><span class="se">\\</span><span class="s">IntelSWTools</span><span class="se">\\</span><span class="s">compilers_and_libraries_2019.0.117</span><span class="se">\\</span><span class="s">windows</span><span class="se">\\</span><span class="s">mkl</span><span class="se">\\</span><span class="s">include&#39;</span><span class="p">,</span> <span class="s">&#39;C:</span><span class="se">\\</span><span class="s">Program Files (x86)</span><span class="se">\\</span><span class="s">IntelSWTools</span><span class="se">\\</span><span class="s">compilers_and_libraries_2019.0.117</span><span class="se">\\</span><span class="s">windows</span><span class="se">\\</span><span class="s">mkl</span><span class="se">\\</span><span class="s">lib&#39;</span><span class="p">,</span> <span class="s">&#39;D:/ProgramData/Anaconda3</span><span class="se">\\</span><span class="s">Library</span><span class="se">\\</span><span class="s">include&#39;</span><span class="p">]</span>      
<span class="n">blas_mkl_info</span><span class="p">:</span>
    <span class="n">libraries</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;mkl_rt&#39;</span><span class="p">]</span>
    <span class="n">library_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;D:/ProgramData/Anaconda3</span><span class="se">\\</span><span class="s">Library</span><span class="se">\\</span><span class="s">lib&#39;</span><span class="p">]</span>
    <span class="n">define_macros</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;SCIPY_MKL_H&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;HAVE_CBLAS&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)]</span>
    <span class="n">include_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;C:</span><span class="se">\\</span><span class="s">Program Files (x86)</span><span class="se">\\</span><span class="s">IntelSWTools</span><span class="se">\\</span><span class="s">compilers_and_libraries_2019.0.117</span><span class="se">\\</span><span class="s">windows</span><span class="se">\\</span><span class="s">mkl&#39;</span><span class="p">,</span> <span class="s">&#39;C:</span><span class="se">\\</span><span class="s">Program Files (x86)</span><span class="se">\\</span><span class="s">IntelSWTools</span><span class="se">\\</span><span class="s">compilers_and_libraries_2019.0.117</span><span class="se">\\</span><span class="s">windows</span><span class="se">\\</span><span class="s">mkl</span><span class="se">\\</span><span class="s">include&#39;</span><span class="p">,</span> <span class="s">&#39;C:</span><span class="se">\\</span><span class="s">Program Files (x86)</span><span class="se">\\</span><span class="s">IntelSWTools</span><span class="se">\\</span><span class="s">compilers_and_libraries_2019.0.117</span><span class="se">\\</span><span class="s">windows</span><span class="se">\\</span><span class="s">mkl</span><span class="se">\\</span><span class="s">lib&#39;</span><span class="p">,</span> <span class="s">&#39;D:/ProgramData/Anaconda3</span><span class="se">\\</span><span class="s">Library</span><span class="se">\\</span><span class="s">include&#39;</span><span class="p">]</span>      
<span class="n">blas_opt_info</span><span class="p">:</span>
    <span class="n">libraries</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;mkl_rt&#39;</span><span class="p">]</span>
    <span class="n">library_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;D:/ProgramData/Anaconda3</span><span class="se">\\</span><span class="s">Library</span><span class="se">\\</span><span class="s">lib&#39;</span><span class="p">]</span>
    <span class="n">define_macros</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;SCIPY_MKL_H&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;HAVE_CBLAS&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)]</span>
    <span class="n">include_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;C:</span><span class="se">\\</span><span class="s">Program Files (x86)</span><span class="se">\\</span><span class="s">IntelSWTools</span><span class="se">\\</span><span class="s">compilers_and_libraries_2019.0.117</span><span class="se">\\</span><span class="s">windows</span><span class="se">\\</span><span class="s">mkl&#39;</span><span class="p">,</span> <span class="s">&#39;C:</span><span class="se">\\</span><span class="s">Program Files (x86)</span><span class="se">\\</span><span class="s">IntelSWTools</span><span class="se">\\</span><span class="s">compilers_and_libraries_2019.0.117</span><span class="se">\\</span><span class="s">windows</span><span class="se">\\</span><span class="s">mkl</span><span class="se">\\</span><span class="s">include&#39;</span><span class="p">,</span> <span class="s">&#39;C:</span><span class="se">\\</span><span class="s">Program Files (x86)</span><span class="se">\\</span><span class="s">IntelSWTools</span><span class="se">\\</span><span class="s">compilers_and_libraries_2019.0.117</span><span class="se">\\</span><span class="s">windows</span><span class="se">\\</span><span class="s">mkl</span><span class="se">\\</span><span class="s">lib&#39;</span><span class="p">,</span> <span class="s">&#39;D:/ProgramData/Anaconda3</span><span class="se">\\</span><span class="s">Library</span><span class="se">\\</span><span class="s">include&#39;</span><span class="p">]</span>      
    <span class="n">libraries</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;mkl_rt&#39;</span><span class="p">]</span>
    <span class="n">library_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;D:/ProgramData/Anaconda3</span><span class="se">\\</span><span class="s">Library</span><span class="se">\\</span><span class="s">lib&#39;</span><span class="p">]</span>
    <span class="n">define_macros</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;SCIPY_MKL_H&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;HAVE_CBLAS&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)]</span>
    <span class="n">include_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;C:</span><span class="se">\\</span><span class="s">Program Files (x86)</span><span class="se">\\</span><span class="s">IntelSWTools</span><span class="se">\\</span><span class="s">compilers_and_libraries_2019.0.117</span><span class="se">\\</span><span class="s">windows</span><span class="se">\\</span><span class="s">mkl&#39;</span><span class="p">,</span> <span class="s">&#39;C:</span><span class="se">\\</span><span class="s">Program Files (x86)</span><span class="se">\\</span><span class="s">IntelSWTools</span><span class="se">\\</span><span class="s">compilers_and_libraries_2019.0.117</span><span class="se">\\</span><span class="s">windows</span><span class="se">\\</span><span class="s">mkl</span><span class="se">\\</span><span class="s">include&#39;</span><span class="p">,</span> <span class="s">&#39;C:</span><span class="se">\\</span><span class="s">Program Files (x86)</span><span class="se">\\</span><span class="s">IntelSWTools</span><span class="se">\\</span><span class="s">compilers_and_libraries_2019.0.117</span><span class="se">\\</span><span class="s">windows</span><span class="se">\\</span><span class="s">mkl</span><span class="se">\\</span><span class="s">lib&#39;</span><span class="p">,</span> <span class="s">&#39;D:/ProgramData/Anaconda3</span><span class="se">\\</span><span class="s">Library</span><span class="se">\\</span><span class="s">include&#39;</span><span class="p">]</span>      
<span class="n">lapack_opt_info</span><span class="p">:</span>
    <span class="n">libraries</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;mkl_rt&#39;</span><span class="p">]</span>
    <span class="n">library_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;D:/ProgramData/Anaconda3</span><span class="se">\\</span><span class="s">Library</span><span class="se">\\</span><span class="s">lib&#39;</span><span class="p">]</span>
    <span class="n">define_macros</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;SCIPY_MKL_H&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;HAVE_CBLAS&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)]</span>
    <span class="n">include_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;C:</span><span class="se">\\</span><span class="s">Program Files (x86)</span><span class="se">\\</span><span class="s">IntelSWTools</span><span class="se">\\</span><span class="s">compilers_and_libraries_2019.0.117</span><span class="se">\\</span><span class="s">windows</span><span class="se">\\</span><span class="s">mkl&#39;</span><span class="p">,</span> <span class="s">&#39;C:</span><span class="se">\\</span><span class="s">Program Files (x86)</span><span class="se">\\</span><span class="s">IntelSWTools</span><span class="se">\\</span><span class="s">compilers_and_libraries_2019.0.117</span><span class="se">\\</span><span class="s">windows</span><span class="se">\\</span><span class="s">mkl</span><span class="se">\\</span><span class="s">include&#39;</span><span class="p">,</span> <span class="s">&#39;C:</span><span class="se">\\</span><span class="s">Program Files (x86)</span><span class="se">\\</span><span class="s">IntelSWTools</span><span class="se">\\</span><span class="s">compilers_and_libraries_2019.0.117</span><span class="se">\\</span><span class="s">windows</span><span class="se">\\</span><span class="s">mkl</span><span class="se">\\</span><span class="s">lib&#39;</span><span class="p">,</span> <span class="s">&#39;D:/ProgramData/Anaconda3</span><span class="se">\\</span><span class="s">Library</span><span class="se">\\</span><span class="s">include&#39;</span><span class="p">]</span> 
</pre></div>


<h2 id="12">1.2. 多维数据在内存的形式</h2>
<p>在 Numpy 中, 创建 2D Array 的默认方式是 <code>C-type</code> 以 row 为主在内存中排列, 而如果是 <code>Fortran</code> 的方式创建的, 就是以 column 为主在内存中排列。</p>
<div class="hlcode"><pre><span class="n">col_major</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>    <span class="c"># C-type</span>
<span class="n">row_major</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s">&#39;F&#39;</span><span class="p">)</span>    <span class="c"># Fortran</span>
</pre></div>


<h2 id="13-copy-vs-view">1.3. 数组选择copy Vs view</h2>
<p>在 Numpy 中, 有两个很重要的概念, copy 和 view. copy 顾名思义, 会将数据 copy 出来存放在内存中另一个地方, 而 view 则是不 copy 数据, 直接取源数据的索引部分. </p>
<p>选择数据的时候, 我们常会用到 view 或者 copy 的形式. 我们知道了, 如果能用到 view 的, 我们就<strong>尽量用 view, 避免 copy 数据</strong>. 那什么时候会是 view 呢? 下面举例的都是 view 的方式:</p>
<div class="hlcode"><pre><span class="o">------</span><span class="n">view</span><span class="o">-----</span>
<span class="n">a_view1</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>    <span class="c"># 切片 slice</span>
<span class="n">a_view2</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span>        <span class="c"># 同上</span>
<span class="n">a_view3</span> <span class="o">=</span> <span class="n">a</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>         <span class="c"># 跳步</span>
<span class="n">a_view4</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>      <span class="c"># 上面提到了</span>
<span class="o">...</span>                      <span class="c"># 我只能想到这些, 如果还有请大家在评论里提出</span>
<span class="err">那哪些操作我们又会变成</span> <span class="n">copy</span> <span class="err">呢?</span>
<span class="o">------</span><span class="n">copy</span><span class="o">-----</span>
<span class="n">a_copy1</span> <span class="o">=</span> <span class="n">a</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">]]</span>   <span class="c"># 用 index 选</span>
<span class="n">a_copy2</span> <span class="o">=</span> <span class="n">a</span><span class="p">[[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">],</span> <span class="p">[</span><span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">]]</span>  <span class="c"># 用 mask</span>
<span class="n">a_copy3</span> <span class="o">=</span> <span class="n">a</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="p">:]</span>        <span class="c"># 虽然 1,2 的确连在一起了, 但是他们确实是 copy</span>
<span class="n">a_copy4</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>  <span class="c"># fancy indexing</span>
<span class="n">a_copy5</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="p">:]</span>  <span class="c"># fancy indexing</span>
<span class="o">...</span>                          <span class="c"># 我只能想到这些, 如果还有请大家在评论里提出</span>
</pre></div>


<p>pandas </p>
<div class="hlcode"><pre><span class="o">---</span> <span class="n">copy</span> <span class="o">---</span>
<span class="n">df</span><span class="o">.</span><span class="n">ix</span><span class="p">[]</span>
<span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[]</span>
<span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[]</span>
<span class="o">---</span> <span class="n">view</span> <span class="o">---</span>
</pre></div>


<p>可以发现当选择的列数 大于1 的时候是copy了的，但是如果只选择一列，则没copy，在对其赋值的时候要格外小心。最好还是copy一下吧</p>
<p>有时候我们会经常把一个DataFrame传进一个函数里，又害怕它被函数里面的语句更改了，所以我一般做法是先df.copy()一下，但是其实我们在用ix, iloc, loc 索引的时候就已经进行了拷贝.</p>
<h2 id="14-out">1.4. 使用 out 参数</h2>
<p>非常有用的 out 参数 --启动view<br />
不深入了解 numpy 的朋友, 应该会直接忽略很多功能中的这个 out 参数 (之前我从来没用过). 不过当我深入了解了以后, 发现他非常有用! 比如下面两个其实在功能上是没差的, 不过运算时间上有差, 我觉得可能是 a=a+1 要先转换成 np.add() 这种形式再运算, 所以前者要用更久一点的时间.</p>
<div class="hlcode"><pre><span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span>         <span class="c"># 0.035230</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c"># 0.032738</span>
</pre></div>


<p>如果是上面那样, 我们就会触发之前提到的 copy 原则, 这两个被赋值的 a, 都是原来 a 的一个 copy, 并不是 a 的 view. 但是在功能里面有一个 out 参数, 让我们不必要重新创建一个 a. 所以下面两个是一样的功能, 都不会创建另一个 copy. 不过可能是上面提到的那个原因, 这里的运算时间也有差.</p>
<div class="hlcode"><pre><span class="n">a</span> <span class="o">+=</span> <span class="mi">1</span>                 <span class="err">#</span> <span class="mf">0.011219</span>
<span class="n">np</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">a</span><span class="p">)</span>    <span class="err">#</span> <span class="mf">0.008843</span>
</pre></div>


<p>带有 out 的 numpy 功能都在这里:<code>Universal functions</code>(https://docs.scipy.org/doc/numpy/reference/ufuncs.html#available-ufuncs). 所以只要是已经存在了一个 placeholder (比如 a), 我们就没有必要去再创建一个, 用 out 方便又有效.</p>
<h2 id="15-gpu">1.5. GPU</h2>
<p>numpy 不支持GPU, pytoch 可以作为 GPU 版本的 NumPy 替代品。</p>
<h1 id="numpy">用好numpy</h1>
<p>在计算方面，实际上有三个概念使NumPy具有强大的功能：</p>
<ol>
<li>向量化</li>
<li>广播</li>
<li>索引编制</li>
</ol>
<p>参考： https://realpython.com/numpy-array-programming/</p>
<h1 id="2-numpy">2. 更小的numpy</h1>
<p>主要针对内存</p>
<div class="hlcode"><pre> <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;int&#39;</span><span class="o">&gt;</span> <span class="n">size</span> <span class="ow">is</span> <span class="mi">12</span>
 <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;bool&#39;</span><span class="o">&gt;</span> <span class="n">size</span> <span class="ow">is</span> <span class="mi">12</span>
 <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;long&#39;</span><span class="o">&gt;</span> <span class="n">size</span> <span class="ow">is</span> <span class="mi">14</span>
 <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;float&#39;</span><span class="o">&gt;</span> <span class="n">size</span> <span class="ow">is</span> <span class="mi">16</span>
 <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;str&#39;</span><span class="o">&gt;</span> <span class="n">size</span> <span class="ow">is</span> <span class="mi">21</span>
 <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;list&#39;</span><span class="o">&gt;</span> <span class="n">size</span> <span class="ow">is</span> <span class="mi">36</span>
 <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;tuple&#39;</span><span class="o">&gt;</span> <span class="n">size</span> <span class="ow">is</span> <span class="mi">28</span>
 <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;dict&#39;</span><span class="o">&gt;</span> <span class="n">size</span> <span class="ow">is</span> <span class="mi">140</span>
 <span class="o">&lt;</span><span class="nb">type</span> <span class="s">&#39;set&#39;</span><span class="o">&gt;</span> <span class="n">size</span> <span class="ow">is</span> <span class="mi">116</span> 


<span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">numpy</span><span class="o">.</span><span class="n">float32</span><span class="s">&#39;&gt; 28</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">numpy</span><span class="o">.</span><span class="n">float64</span><span class="s">&#39;&gt; 32</span>

<span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">numpy</span><span class="o">.</span><span class="n">int64</span><span class="s">&#39;&gt; 32</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">numpy</span><span class="o">.</span><span class="n">int32</span><span class="s">&#39;&gt; 28</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">numpy</span><span class="o">.</span><span class="n">int16</span><span class="s">&#39;&gt; 26</span>

<span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="s">&#39;&gt; 100     # np.int</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="s">&#39;&gt; 100     # np.float32</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="s">&#39;&gt; 104     # np.float64</span>
</pre></div>


<p>numpy 默认浮点为float64</p>
<h1 id="3">3. 测试</h1>
<div class="hlcode"><pre><span class="c"># 测试用例1--SVD 奇异值分解</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">t0</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">t1</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">print</span> <span class="p">(</span><span class="s">&quot;time cost {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">))</span>

<span class="n">time</span> <span class="n">cost</span> <span class="mi">0</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mf">12.010129</span> <span class="c"># ubuntu conda numpy mkl</span>
<span class="n">time</span> <span class="n">cost</span> <span class="mi">0</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mf">13.581722</span> <span class="c"># ubuntu conda numpy </span>

<span class="n">time</span> <span class="n">cost</span> <span class="mi">0</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mf">12.934425</span> <span class="c"># windows conda numpy mkl</span>
<span class="n">time</span> <span class="n">cost</span> <span class="mi">0</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mf">13.737275</span> <span class="c"># windows conda numpy </span>

<span class="n">time</span> <span class="n">cost</span> <span class="mi">0</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mf">20.864863</span> <span class="c"># colab Linux numpy</span>
</pre></div>


<h1 id="4">4. 参考资料</h1>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>How To Make Your Pandas Loop 71803 Times Faster https://towardsdatascience.com/how-to-make-your-pandas-loop-71-803-times-faster-805030df4f06&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
</div>
<div id="renote">
  <HR style=" FILTER: alpha (opacity = 100, finishopacity =0 , style= 3 )" width="80%" color=#987 cb 9 SIZE=3>
  <p>如果你觉得这篇文章对你有帮助，不妨请我喝杯咖啡，鼓励我创造更多!</p>
  <img src="/Wiki/static/images/pay.jpg" width="25%">
</div>

    </div>
    <div id="footer">
        <span>
            Copyright © 2021 zhang787jun.
            Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
        </span>
    </div>

    
</body>
<script>
    function changeImgurl(site_root_url) {
        var images = document.images;
        var site_root = site_root_url;
        for (i = 0, len = images.length; i < len; i++) {
            image = images[i];
            image_src = image.src;
            if (image_src.search("attach") >= 0) {
                re_image_src = image_src.slice(image_src.search("attach"));
                abs_image_src = (site_root.endsWith("/")) ? site_root + re_image_src : site_root + "/" +
                    re_image_src;
                image.src = abs_image_src;
            }
        }
    }
    var site_root_url = "/Wiki";
    changeImgurl(site_root_url);
    let isMathjaxConfig = false; // 防止重复调用Config，造成性能损耗
    const initMathjaxConfig = () => {
        if (!window.MathJax) {
            return;
        }
        window.MathJax.Hub.Config({
            showProcessingMessages: false, //关闭js加载过程信息
            messageStyle: "none", //不显示信息
            jax: ["input/TeX", "output/HTML-CSS"],
            tex2jax: {
                inlineMath: [["$", "$"], ["\\(", "\\)"]], //行内公式选择符
                displayMath: [["$$", "$$"], ["\\[", "\\]"]], //段内公式选择符
                skipTags: ["script", "noscript", "style", "textarea", "pre", "code", "a"] //避开某些标签
            },
            "HTML-CSS": {
                availableFonts: ["STIX", "TeX"], //可选字体
                showMathMenu: false //关闭右击菜单显示
            }
        });
        isMathjaxConfig = true; //
    };
    if (isMathjaxConfig === false) {
        // 如果：没有配置MathJax
        initMathjaxConfig();
    };
</script>

</html>