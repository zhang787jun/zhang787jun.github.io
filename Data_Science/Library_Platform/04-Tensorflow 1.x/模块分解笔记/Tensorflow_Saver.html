<!DOCTYPE HTML>
<html>

<head>
    <link rel="Stylesheet" type="text/css" href="/Wiki/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/Wiki/static/css/tango.css">
    <link rel="shortcut icon" href="/Wiki/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/Wiki/favicon.ico" type="image/x-icon">
    <title>Tensorflow_Saver 模型的保存与加载 - Jun's personal knowledge wiki</title>
    <meta name="keywords" content="Technology, MachineLearning, DataMining, Wiki" />
    <meta name="description" content="A wiki website" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
            }
        });
    </script>
    <script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
        </script>
</head>

<body>

    <div id="container">
        
<div id="header">
  <div id="post-nav"><a href="/Wiki/">Home</a>&nbsp;»&nbsp;<a href="/Wiki/#Data_Science">Data_Science</a>&nbsp;»&nbsp;<a href="/Wiki/#-Library_Platform">Library_Platform</a>&nbsp;»&nbsp;<a href="/Wiki/#-04-Tensorflow 1.x">04-Tensorflow 1.x</a>&nbsp;»&nbsp;<a href="/Wiki/#-模块分解笔记">模块分解笔记</a>&nbsp;»&nbsp;Tensorflow_Saver 模型的保存与加载</div>
</div>
<div class="clearfix"></div>
<div id="title">Tensorflow_Saver 模型的保存与加载</div>
<div id="content">
  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#1">1. 模型的保存</a><ul>
<li><a href="#11">1.1. 几个概念</a><ul>
<li><a href="#111">1.1.1. 序列化 与 反序列化</a></li>
<li><a href="#112-protobuf">1.1.2. Protobuf</a></li>
</ul>
</li>
<li><a href="#12">1.2. 理论上需要保存什么</a><ul>
<li><a href="#121">1.2.1. 图信息</a><ul>
<li><a href="#1211-node-operation">1.2.1.1. Node节点信息--operation</a></li>
<li><a href="#1212-edge-tensor">1.2.1.2. Edge边缘信息--Tensor</a></li>
</ul>
</li>
<li><a href="#122">1.2.2. 参数信息</a></li>
<li><a href="#123">1.2.3. 其他信息</a><ul>
<li><a href="#1231">1.2.3.1. 服务器信息</a></li>
<li><a href="#1232">1.2.3.2. 集群信息</a></li>
<li><a href="#1233-checkpoint">1.2.3.3. Checkpoint</a></li>
<li><a href="#1234">1.2.3.4. 版本和其他用户信息</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#13">1.3. 实践中以什么形式保存</a><ul>
<li><a href="#131-metagraphdef">1.3.1. MetaGraphDef 元图信息</a></li>
<li><a href="#132-variables">1.3.2. Variables 变量数据</a></li>
<li><a href="#133-checkpoint">1.3.3. Checkpoint</a></li>
</ul>
</li>
<li><a href="#14">1.4. 实践中怎样组织保存文件</a><ul>
<li><a href="#141-checkpoint_model">1.4.1. checkpoint_model</a></li>
<li><a href="#142-saved-model">1.4.2. Saved Model</a></li>
<li><a href="#143-frozengraph">1.4.3. FrozenGraph</a></li>
<li><a href="#144-tflite">1.4.4. Tflite</a></li>
</ul>
</li>
<li><a href="#15-checkpoint_model">1.5. 怎么保存checkpoint_model</a><ul>
<li><a href="#151-tfsaver">1.5.1. tf.saver</a></li>
</ul>
</li>
<li><a href="#16-saved_model">1.6. 怎么保存Saved_model 版本</a><ul>
<li><a href="#161-savedmodebuilder">1.6.1. [基础模块]SavedModeBuilder</a><ul>
<li><a href="#1611">1.6.1.1. 基本步骤</a></li>
<li><a href="#1612">1.6.1.2. 关键模块说明</a><ul>
<li><a href="#16121-signature_def_map">1.6.1.2.1. 签名 signature_def_map</a></li>
<li><a href="#16122-assets">1.6.1.2.2. 资源集合assets</a></li>
<li><a href="#16123-legacy_init_op">1.6.1.2.3. legacy_init_op  初始化操作</a></li>
<li><a href="#16124-tags">1.6.1.2.4. tags 标签</a></li>
<li><a href="#16125">1.6.1.2.5. 注意事项</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#162-tfestimatorsavedmodel">1.6.2. [高阶模块] tf.estimator中的savedmodel</a><ul>
<li><a href="#serving_input_receiver_fn">serving_input_receiver_fn</a></li>
<li><a href="#assets_extra">assets_extra</a></li>
<li><a href="#metagraph">实现多个metagraph</a></li>
</ul>
</li>
<li><a href="#163-sess-saved_model">1.6.3. [高阶模块] sess中简化版本的 saved_model</a></li>
<li><a href="#164-tfkeras">1.6.4. [高阶模块] tf.keras中如何实现</a></li>
<li><a href="#165-bazel">1.6.5. Bazel</a></li>
</ul>
</li>
<li><a href="#17-frozengraph">1.7. 怎么保存FrozenGraph</a><ul>
<li><a href="#171-tfgfilegfile">1.7.1. tf.gfile.GFile()</a></li>
</ul>
</li>
<li><a href="#18-tflite_model">1.8. 怎么保存 TFlite_Model</a></li>
</ul>
</li>
<li><a href="#2">2. 模型的加载</a><ul>
<li><a href="#21-checkpoint_model">2.1. checkpoint_model 加载</a><ul>
<li><a href="#211-tfsaver-restore">2.1.1. tf.saver restore</a></li>
</ul>
</li>
<li><a href="#22-saved-mode">2.2. Saved mode 加载</a><ul>
<li><a href="#sess">加载到sess 中</a></li>
<li><a href="#keras-model">加载到keras model 中</a></li>
</ul>
</li>
<li><a href="#23-frozengraph">2.3. FrozenGraph 加载</a></li>
</ul>
</li>
<li><a href="#3">3. 模型转换</a><ul>
<li><a href="#31-ckpt-pd">3.1. ckpt -&gt; pd</a></li>
<li><a href="#32-h5-pd">3.2. h5 -&gt;pd</a></li>
<li><a href="#frozengraph-savedmodel">FrozenGraph-&gt;SavedModel</a></li>
</ul>
</li>
<li><a href="#5">5. 参考资料</a></li>
</ul>
</div>
<h1 id="1">1. 模型的保存</h1>
<h2 id="11">1.1. 几个概念</h2>
<h3 id="111">1.1.1. 序列化 与 反序列化</h3>
<p><strong>数据序列化</strong>就是将对象或者数据结构转化成特定的格式，使其可在网络中传输或者可存储在内存或者文件中。</p>
<p>廖雪峰：变量从内存中变成可存储或传输的过程称之为序列化。</p>
<p>对象序列化后的数据格式可以是二进制，可以是XML，也可以是JSON等任何格式。</p>
<p><strong>反序列化</strong>是序列化相反的操作，将对象从序列化数据中还原出来。</p>
<p>廖雪峰：把变量内容从序列化的对象重新读到内存里称之为反序列化。</p>
<h3 id="112-protobuf">1.1.2. Protobuf</h3>
<p>Google Protocol Buffers（简称 Protobuf，协议缓存）是谷歌开放的处理结构化数据的工具。Protobuf是类似json的一种数据格式，但不同的是他是二进制格式，性能好、读写效率高。<br />
Protobuf文件通常以<code>.proto</code>结尾。</p>
<p>https://tensorflow.juejin.im/extend/tool_developers/index.html</p>
<p>Protobuf 实际上支持两种不同的文件保存格式：（1）TextFormat 和（2）二进制格式。<br />
1. TextFormat 是一种人眼可读的文本形式，这在调试和编辑时是很方便的，但它在存储数值数据时会变得很大。比如我们常见的权重数据，文件名为 <code>xxx.pbtxt</code>。<br />
2. 二进制格式的文件会小得多，缺点就是它不易读。文件名为 <code>xxx.pb</code>。</p>
<p>Protocol Buffer <br />
特性：<br />
1. 处理结构化数据的工具<br />
2. 二进制流<br />
3. 需要先定义数据格式（schema）,才能还原<br />
4. 序列化数据比xml 小3~10倍，解析快20~100倍<br />
5. 每一个message代表了一类结构体和的数据</p>
<h2 id="12">1.2. 理论上需要保存什么</h2>
<p>主要是：</p>
<table>
<thead>
<tr>
<th>编号</th>
<th>项目</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>图信息</td>
</tr>
<tr>
<td>2</td>
<td>变量信息</td>
</tr>
<tr>
<td>3</td>
<td>其他信息（服务器信息）</td>
</tr>
</tbody>
</table>
<h4 id="121">1.2.1. 图信息</h4>
<p>图被定义为 “一些 Operation（Node节点） 和 Tensor（Edge边缘）的集合”。</p>
<p>图信息的主要内容包括： <br />
1.Node节点信息（op）<br />
2.边信息（Tensor）。</p>
<h5 id="1211-node-operation">1.2.1.1. Node节点信息--operation</h5>
<p>图中的节点又称为算子，它代表一个操作（operation，OP），一般用来表示施加的数学运算，也可以表示数据输入（feed in）的起点以及输出（push out）的终点，或者是读取/写入持久 变量（persistent variable）的终点。</p>
<p>Operation包含OpDef和NodeDef两个主要成员变量。<br />
1. OpDef描述了op的静态属性信息，例如op入参列表，出参列表等。<br />
2. NodeDef则描述op的动态属性信息，例如op运行的设备信息，用户给op设置的name等。包括placeholder,placeholder 是tensor </p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">get_operations</span><span class="p">()]</span>
</pre></div>


<h5 id="1212-edge-tensor">1.2.1.2. Edge边缘信息--Tensor</h5>
<p>边用来表示计算的数据，它经过上游节点计算后得到，然后传递给下游节点进行运算。</p>
<p>Tensor中主要包含两类信息：<br />
1. 是Graph结构信息，如边的源节点和目标节点(有向图)。<br />
2. 它所保存的数据信息，例如数据类型，shape等（tensor.shape/tensor.dytpe）。</p>
<h4 id="122">1.2.2. 参数信息</h4>
<p>tf.Varibel </p>
<h4 id="123">1.2.3. 其他信息</h4>
<h5 id="1231">1.2.3.1. 服务器信息</h5>
<h5 id="1232">1.2.3.2. 集群信息</h5>
<h5 id="1233-checkpoint">1.2.3.3. Checkpoint</h5>
<p>用于保存模型的权重，主要用于模型训练过程中参数的备份和模型训练热启动。<br />
主要内容包括：</p>
<div class="hlcode"><pre><span class="n">model_checkpoint_path</span><span class="o">=</span> <span class="n">xxx</span><span class="p">;</span>
<span class="n">all_model_checkpoint_path</span><span class="o">=</span><span class="n">xxx</span><span class="p">;</span>
</pre></div>


<h5 id="1234">1.2.3.4. 版本和其他用户信息</h5>
<h2 id="13">1.3. 实践中以什么形式保存</h2>
<h3 id="131-metagraphdef">1.3.1. MetaGraphDef 元图信息</h3>
<p>在实际操作中，很少单独持久化Graph信息，一般都是直接保存MetaGraph信息，MetaGraphDef 是 MetaGraph信息的序列化文件，同样是由 Protocol Buffer来定义的一个包含<strong>更多图信息</strong>的序列化文件。其中包括：</p>
<table>
<thead>
<tr>
<th align="left">组成</th>
<th align="left">内容</th>
<th align="right">例如</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">MetaInfoDef</td>
<td align="left">存一些元信息</td>
<td align="right">版本和其他用户信息</td>
</tr>
<tr>
<td align="left">GraphDef</td>
<td align="left">Graph的序列化信息，MetaGraph的核心内容之一 ,不包含模型权重变量信息</td>
<td align="right">Node(Placeholder + op)</td>
</tr>
<tr>
<td align="left">SaverDef</td>
<td align="left">图的Saver信息</td>
<td align="right">最多同时保存的check-point数量；需保存的Tensor名字等，但并不保存Tensor中的实际内容</td>
</tr>
<tr>
<td align="left">CollectionDef</td>
<td align="left">任何需要特殊注意的 Python 对象，需要特殊的标注以方便import_meta_graph 后取回。</td>
<td align="right">"train_op","prediction"等等</td>
</tr>
</tbody>
</table>
<div class="hlcode"><pre><span class="n">graph</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span>
<span class="n">graph_def</span><span class="o">=</span><span class="n">graph</span><span class="o">.</span><span class="n">as_graph_def</span><span class="p">()</span>
<span class="c">##</span>
<span class="nb">type</span><span class="p">(</span><span class="n">graph_def</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">graph_pb2</span><span class="o">.</span><span class="n">GraphDef</span>

<span class="c">##</span>
<span class="n">graph_def</span>
<span class="o">&gt;&gt;&gt;</span>
  <span class="n">node</span> <span class="p">{</span>
    <span class="n">name</span><span class="p">:</span> <span class="s">&quot;start&quot;</span>
    <span class="n">op</span><span class="p">:</span> <span class="s">&quot;Const&quot;</span>
    <span class="n">attr</span> <span class="p">{</span>
      <span class="n">key</span><span class="p">:</span> <span class="s">&quot;dtype&quot;</span>
      <span class="n">value</span> <span class="p">{</span>
        <span class="nb">type</span><span class="p">:</span> <span class="n">DT_INT64</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">attr</span> <span class="p">{</span>
      <span class="n">key</span><span class="p">:</span> <span class="s">&quot;value&quot;</span>
      <span class="n">value</span> <span class="p">{</span>
        <span class="n">tensor</span> <span class="p">{</span>
          <span class="n">dtype</span><span class="p">:</span> <span class="n">DT_INT64</span>
          <span class="n">tensor_shape</span> <span class="p">{</span>
          <span class="p">}</span>
          <span class="n">int64_val</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">library</span> <span class="p">{</span>
    <span class="n">function</span> <span class="p">{</span>
      <span class="n">signature</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="s">&quot;_make_dataset_YADYq1MF2s4&quot;</span>
        <span class="n">output_arg</span> <span class="p">{</span>
          <span class="n">name</span><span class="p">:</span> <span class="s">&quot;modeldataset&quot;</span>
          <span class="nb">type</span><span class="p">:</span> <span class="n">DT_VARIANT</span>
        <span class="p">}</span>
        <span class="n">description</span><span class="p">:</span> <span class="s">&quot;Factory function for a dataset.&quot;</span>
        <span class="n">is_stateful</span><span class="p">:</span> <span class="n">true</span>
      <span class="p">}</span>
      <span class="n">node_def</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="s">&quot;RangeDataset/start&quot;</span>
        <span class="n">op</span><span class="p">:</span> <span class="s">&quot;Const&quot;</span>
        <span class="n">attr</span> <span class="p">{</span>
          <span class="n">key</span><span class="p">:</span> <span class="s">&quot;dtype&quot;</span>
          <span class="n">value</span> <span class="p">{</span>
            <span class="nb">type</span><span class="p">:</span> <span class="n">DT_INT64</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">attr</span> <span class="p">{</span>
          <span class="n">key</span><span class="p">:</span> <span class="s">&quot;value&quot;</span>
          <span class="n">value</span> <span class="p">{</span>
            <span class="n">tensor</span> <span class="p">{</span>
              <span class="n">dtype</span><span class="p">:</span> <span class="n">DT_INT64</span>
              <span class="n">tensor_shape</span> <span class="p">{</span>
              <span class="p">}</span>
              <span class="n">int64_val</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">ret</span> <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="s">&quot;modeldataset&quot;</span>
        <span class="n">value</span><span class="p">:</span> <span class="s">&quot;ModelDataset:handle:0&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">versions</span> <span class="p">{</span>
    <span class="n">producer</span><span class="p">:</span> <span class="mi">27</span>
    <span class="n">min_consumer</span><span class="p">:</span> <span class="mi">12</span>
  <span class="p">}</span>
</pre></div>


<p>保存MetaGraph信息的文件格式主要有</p>
<ol>
<li>
<p>pd 格式<br />
形如<code>xxx_name.pd</code></p>
</li>
<li>
<p>meta 格式<br />
形如<code>xxx_name.meta</code></p>
</li>
</ol>
<h3 id="132-variables">1.3.2. Variables 变量数据</h3>
<p><strong>范围</strong><br />
主要为<code>tf.Variables</code>类的节点信息。<br />
<strong>内容</strong><br />
主要为变量：<br />
1. 初始值<br />
2. 具体数值<br />
3. shape等。</p>
<p><strong>持久化格式</strong><br />
参数信息持久化时保存为(1)索引和(2)数据 两部分。其中：<br />
1. 索引命名为: <code>xxx_name.index</code><br />
2. 数据命名为: <code>xxx_name.data</code></p>
<table>
<thead>
<tr>
<th>filename</th>
<th>类型</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>model.ckpt-20.index</td>
<td>二进制文件</td>
<td>数据 index</td>
</tr>
<tr>
<td>model.ckpt-20.data-00000-of-00002</td>
<td>二进制文件</td>
<td>数据</td>
</tr>
</tbody>
</table>
<h3 id="133-checkpoint">1.3.3. Checkpoint</h3>
<p><strong>范围及内容</strong><br />
Checkpoint记录：<br />
1. all_model_checkpoint_paths<br />
2. model_checkpoint_path </p>
<p><strong>持久化格式</strong></p>
<p>持久化格式保存为 <code>Checkpoint</code>，没有后缀格式，可以直接用记事本打开，为文本类文件。</p>
<h2 id="14">1.4. 实践中怎样组织保存文件</h2>
<p>TensorFlow提供3种模型保存模型：</p>
<ol>
<li>checkpoints，这是一种依赖于创建模型的代码的格式。</li>
<li>SavedModel，这是一种独立于创建模型的代码的格式。</li>
<li>FrozenGraph，将变量信息设定为常量的模型</li>
<li>tflite ，支持安卓和ios设备的模型格式</li>
</ol>
<h3 id="141-checkpoint_model">1.4.1. checkpoint_model</h3>
<h3 id="142-saved-model">1.4.2. Saved Model</h3>
<p>在此环境中，Saved Model允许你使用不同的配置保存图形。在我们的例子中，我们有三个不同的图形和相应的标签，如“训练”、“推理”和“移动”。此外，这三个图形为了提升内存效率还<strong>共享相同的变量集</strong>。</p>
<p>就在不久前，如果我们想在移动设备上部署TF模型时，我们需要知道输入和输出张量的名称，以便向模型提供数据或从模型获取数据。这需要强制程序员在图的所有张量中搜索他们所需的张量。如果张量没有正确命名，那么任务可能非常繁琐。</p>
<p>为了简化操作，SavedModel提供对SignatureDefs的支持，SignatureDefs定义了TensorFlow支持的计算的签名。它确定了计算图的正确输入和输出张量，也就是说使用这些签名，你可以指定用于输入和输出的确切节点。要使用其内置的服务API，TF Serving要求模型包含一个或多个SignatureDefs。</p>
<h3 id="143-frozengraph">1.4.3. FrozenGraph</h3>
<p>将图中的变量变为常量，压缩模型。</p>
<h3 id="144-tflite">1.4.4. Tflite</h3>
<p>可供TensorFlow Lite 框架使用tflite文件</p>
<h2 id="15-checkpoint_model">1.5. 怎么保存checkpoint_model</h2>
<h3 id="151-tfsaver">1.5.1. tf.saver</h3>
<p>saver是一个<code>tensorflow.python.training.saver.Saver</code> 类， <br />
saver的建立主要通过 tf.train 子类建立，有以下方式:<br />
1. saver = tf.train.Saver()<br />
2. saver = tf.train.import_meta_graph()</p>
<p>返回MetaGraphDef里面的saver_def 或者None</p>
<p>参数</p>
<div class="hlcode"><pre><span class="k">class</span> <span class="nc">Saver</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
                <span class="n">var_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">reshape</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">sharded</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">max_to_keep</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="c">#即保存最近五个checkpoint模型文件</span>
                <span class="n">keep_checkpoint_every_n_hours</span><span class="o">=</span><span class="mf">10000.0</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">restore_sequentially</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">saver_def</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">builder</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">defer_build</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">allow_empty</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">write_version</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">SaverDef</span><span class="o">.</span><span class="n">V2</span><span class="p">,</span>
                <span class="n">pad_step_number</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">save_relative_paths</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="c">#为True时，checkpoint文件将不会记录完整的模型路径，而只会仅仅记录模型名字，这方便于将保存下来的模型复制到其他目录并使用的情况；</span>
                <span class="n">filename</span><span class="o">=</span><span class="bp">None</span>
        <span class="p">)</span>
</pre></div>


<p>方法</p>
<div class="hlcode"><pre><span class="mf">1.</span> <span class="n">as_saver_def</span>
         <span class="err">返回一个</span> <span class="n">SaverDef</span> <span class="n">proto</span>
<span class="mf">2.</span> <span class="n">build</span> 
<span class="mf">3.</span> <span class="n">export_meta_graph</span>  <span class="err">返回一个</span><span class="n">MetaGraphDef</span>
<span class="mf">4.</span> <span class="n">from_proto</span>   <span class="err">从</span>  <span class="n">saver_def</span> <span class="err">返回以一个</span><span class="n">Saver</span> <span class="n">built</span>
<span class="mf">5.</span> <span class="n">recover_last_checkpoints</span> <span class="err">从错误中恢复</span> <span class="n">saver</span><span class="err">的初始状态</span>
<span class="mf">6.</span> <span class="n">restore</span>  <span class="o">--</span><span class="err">恢复先前保存的参数变量</span>
<span class="mf">7.</span> <span class="n">save</span> <span class="o">--</span> <span class="err">保存参数变量</span>

<span class="n">save</span><span class="p">(</span>
    <span class="n">sess</span><span class="p">,</span>
    <span class="n">save_path</span><span class="p">,</span>
    <span class="n">global_step</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">latest_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">meta_graph_suffix</span><span class="o">=</span><span class="s">&#39;meta&#39;</span><span class="p">,</span>
    <span class="n">write_meta_graph</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">write_state</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">strip_default_attrs</span><span class="o">=</span><span class="bp">False</span>
<span class="p">)</span>

<span class="mf">8.</span> <span class="n">set_last_checkpoints</span> <span class="o">--</span>
<span class="mf">9.</span> <span class="n">set_last_checkpoints_with_time</span>
<span class="mf">10.</span> <span class="n">to_proto</span><span class="err">。将</span>  <span class="n">Saver</span> <span class="err">转化成</span> <span class="n">a</span> <span class="n">SaverDef</span> <span class="n">protocol</span> <span class="nb">buffer</span><span class="o">.</span>
</pre></div>


<p>使用tf.saver <br />
1. 将 MetaGraphDef图信息以.meta 格式，<br />
2. 将参数信息保存为.index .data 格式<br />
3. 创建一个txt 可读文件 checkpoint</p>
<table>
<thead>
<tr>
<th align="right">文件名</th>
<th align="right">文件类型</th>
<th align="right">描述</th>
<th align="right"></th>
</tr>
</thead>
<tbody>
<tr>
<td align="right">checkpoint</td>
<td align="right">文本文件</td>
<td align="right">可直接记事本打开，记录检查点信息</td>
<td align="right">model_checkpoint_path;all_model_checkpoint_path</td>
</tr>
<tr>
<td align="right">model.ckpt-0.meta</td>
<td align="right">二进制文件</td>
<td align="right">图结构</td>
<td align="right"></td>
</tr>
<tr>
<td align="right">model.ckpt-20.index</td>
<td align="right">二进制文件</td>
<td align="right">数据 index</td>
<td align="right"></td>
</tr>
<tr>
<td align="right">model.ckpt-20.data-00000-of-00002</td>
<td align="right">二进制文件</td>
<td align="right">数据</td>
<td align="right"></td>
</tr>
</tbody>
</table>
<p>其主要操作为<code>tf.saver</code></p>
<div class="hlcode"><pre><span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
  <span class="o">....</span>
  <span class="n">saver</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Saver</span><span class="p">()</span>
  <span class="n">step</span><span class="o">=</span><span class="mi">0</span>
  <span class="k">while</span> <span class="n">is_runing</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="n">step</span><span class="o">+=</span><span class="mi">1</span>
    <span class="n">saver_path</span> <span class="o">=</span> <span class="n">saver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">file_name</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">global_step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>

<span class="c"># saver_path: str &lt;file_name&gt;-&lt;global_step&gt;</span>

<span class="c"># &lt;file_name&gt; 不带文件格式，仅仅是文件名</span>
<span class="n">saver_path</span><span class="o">=</span> <span class="n">saver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="s">&#39;my-model&#39;</span><span class="p">,</span> <span class="n">global_step</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">saver_path</span><span class="p">:</span> <span class="s">&#39;my-model-0&#39;</span>
<span class="n">saver_path</span><span class="o">=</span><span class="n">saver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="s">&#39;my-model.ckpt&#39;</span><span class="p">,</span> <span class="n">global_step</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">saver_path</span><span class="p">:</span> <span class="s">&#39;my-model.ckpt-0&#39;</span>
<span class="o">...</span>
<span class="n">saver_path</span><span class="o">=</span> <span class="n">saver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="s">&#39;my-model&#39;</span><span class="p">,</span> <span class="n">global_step</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">saver_path</span><span class="p">:</span> <span class="s">&#39;my-model-1000&#39;</span>
</pre></div>


<p>上述程序同时保存4 个文件 <br />
1. <code>&lt;file_name&gt;-&lt;global_step&gt;.meta</code>, <br />
2. <code>&lt;file_name&gt;-&lt;global_step&gt;.index</code>,<br />
3. <code>&lt;file_name&gt;-&lt;global_step&gt;.data-00000-of-00001</code><br />
4. checkpoints</p>
<h2 id="16-saved_model">1.6. 怎么保存Saved_model 版本</h2>
<h3 id="161-savedmodebuilder">1.6.1. [基础模块]SavedModeBuilder</h3>
<p>SavedModel：使用saved_model接口导出的模型文件，包含模型Graph和权限可直接用于上线Tensorflow serving，TensorFlow和Keras模型推荐使用这种模型格式。</p>
<p>例如，图显示了一个包含三个 MetaGraphDef 的 SavedModel，它们三个都共享同一组检查点和资源：</p>
<p><img alt="" src="../../../../../attach/images/2019-10-09-11-23-18.png" /></p>
<p>SavedModel 是一种独立于语言且可恢复的神秘序列化格式，使较高级别的系统和工具可以创建、使用和转换 TensorFlow 模型。</p>
<h4 id="1611">1.6.1.1. 基本步骤</h4>
<div class="hlcode"><pre><span class="n">export_dir</span> <span class="o">=</span> <span class="o">...</span>
<span class="o">...</span>
<span class="c"># 1. 模型构建实例 builder</span>
<span class="n">builder</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">SavedModelBuilder</span><span class="p">(</span><span class="n">export_dir</span><span class="p">)</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">())</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
  <span class="o">...</span>
  <span class="c"># 2. sess 中往builder 添加元图和变量信息</span>
  <span class="n">builder</span><span class="o">.</span><span class="n">add_meta_graph_and_variables</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span>
                                       <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">tag_constants</span><span class="o">.</span><span class="n">TRAINING</span><span class="p">],</span>
                                       <span class="n">signature_def_map</span><span class="o">=</span><span class="n">foo_signatures</span><span class="p">,</span>
                                       <span class="n">assets_collection</span><span class="o">=</span><span class="n">foo_assets</span><span class="p">)</span>
<span class="o">...</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">())</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
  <span class="o">...</span>
  <span class="n">builder</span><span class="o">.</span><span class="n">add_meta_graph</span><span class="p">([</span><span class="s">&quot;bar-tag&quot;</span><span class="p">,</span> <span class="s">&quot;baz-tag&quot;</span><span class="p">])</span>
<span class="o">...</span>

<span class="c"># 3.builder 持久化保存</span>
<span class="n">builder</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>


<h4 id="1612">1.6.1.2. 关键模块说明</h4>
<p>add_meta_graph_and_variables 为关键操作</p>
<div class="hlcode"><pre><span class="n">add_meta_graph_and_variables</span><span class="p">(</span>
    <span class="n">sess</span><span class="p">,</span>
    <span class="n">tags</span><span class="p">,</span><span class="c"># tags:list; tags=[&quot;tag_string&quot;,&quot;..&quot;,...]</span>
    <span class="n">signature_def_map</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="c"># signature_def_map:dict{&quot;string_name&quot;:(signature_def)} :{string:tuple}</span>
    <span class="n">assets_collection</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">legacy_init_op</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">clear_devices</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">main_op</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">strip_default_attrs</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="c"># 通过 strip_default_attrs=True 确保向前兼容性</span>
    <span class="n">saver</span><span class="o">=</span><span class="bp">None</span>
<span class="p">)</span>

<span class="c"># sess：用于执行添加元图和变量功能的会话；</span>
<span class="c"># tags：用于保存元图的标签,[str,str..]；</span>
<span class="c"># signature_def_map：用于保存元图的签名；</span>
<span class="c"># assets_collection：使用SavedModel保存的资源集合；</span>
<span class="c"># legacy_init_op：在恢复模型操作后，对Op和Ops组的遗留支持；</span>
<span class="c"># clear_devices：如果默认图形上的设备信息应该被清除，则应该设置为true；</span>
<span class="c"># main_op：在加载图时执行Op或Ops组的操作。请注意，当main_op被指定时，它将在加载恢复op后运行；</span>
</pre></div>


<h5 id="16121-signature_def_map">1.6.1.2.1. 签名 signature_def_map</h5>
<p><code>signature_def_map</code> 定义签名的字典，这里的签名，并非是为了保证模型不被修改的那种电子签名。是类似于编程语言中模块的输入输出信息，比如函数名，输入参数类型，输出参数类型等等。</p>
<div class="hlcode"><pre><span class="n">signature_def_map</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;name&quot;</span><span class="p">:(</span><span class="n">SignatureDef</span><span class="p">)}</span>
</pre></div>


<p><code>SignatureDef</code> 是一个协议缓冲区，用于定义图所支持的计算的签名。常用的输入键、输出键和方法名称定义如下<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup><br />
https://github.com/tensorflow/serving/blob/master/tensorflow_serving/g3doc/signature_defs.md</p>
<p>主要通过 <code>tf.saved_model.signature_def_utils.build_signature_def</code> 进行构建 </p>
<div class="hlcode"><pre><span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">signature_def_utils</span><span class="o">.</span><span class="n">build_signature_def</span><span class="p">(</span>
    <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;images&#39;</span><span class="p">:</span> <span class="n">tensor_x</span><span class="p">},</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;scores&#39;</span><span class="p">:</span> <span class="n">tensor_y</span><span class="p">},</span>
    <span class="n">method_name</span><span class="o">=</span><span class="s">&quot;predict&quot;</span>
    <span class="p">)</span>
</pre></div>


<p><strong>实例：构建分类模型的签名</strong></p>
<div class="hlcode"><pre><span class="c"># Build the signature_def_map.</span>
<span class="c"># 构建 签名 signature_def_map </span>
<span class="c"># signature_def_map 主要有两部分组成：</span>
<span class="c"># 1.predict_images 2.serving_default</span>

<span class="c"># *********** 1. 构建分类签名</span>
<span class="n">classification_inputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_tensor_info</span><span class="p">(</span>
    <span class="n">serialized_tf_example</span><span class="p">)</span>
<span class="n">classification_outputs_classes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_tensor_info</span><span class="p">(</span>
    <span class="n">prediction_classes</span><span class="p">)</span>
<span class="n">classification_outputs_scores</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_tensor_info</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

<span class="n">classification_signature</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">signature_def_utils</span><span class="o">.</span><span class="n">build_signature_def</span><span class="p">(</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">{</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">signature_constants</span><span class="o">.</span><span class="n">CLASSIFY_INPUTS</span><span class="p">:</span>
                <span class="n">classification_inputs</span>
        <span class="p">},</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">{</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">signature_constants</span><span class="o">.</span><span class="n">CLASSIFY_OUTPUT_CLASSES</span><span class="p">:</span>
                <span class="n">classification_outputs_classes</span><span class="p">,</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">signature_constants</span><span class="o">.</span><span class="n">CLASSIFY_OUTPUT_SCORES</span><span class="p">:</span>
                <span class="n">classification_outputs_scores</span>
        <span class="p">},</span>
        <span class="n">method_name</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">signature_constants</span><span class="o">.</span><span class="n">CLASSIFY_METHOD_NAME</span><span class="p">)</span>
        <span class="p">)</span>
<span class="c"># *********** 2. 构建预测签名</span>

<span class="n">tensor_info_x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_tensor_info</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">tensor_info_y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_tensor_info</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">prediction_signature</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">signature_def_utils</span><span class="o">.</span><span class="n">build_signature_def</span><span class="p">(</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;images&#39;</span><span class="p">:</span> <span class="n">tensor_info_x</span><span class="p">},</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;scores&#39;</span><span class="p">:</span> <span class="n">tensor_info_y</span><span class="p">},</span>
        <span class="n">method_name</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">signature_constants</span><span class="o">.</span><span class="n">PREDICT_METHOD_NAME</span><span class="p">)</span>
        <span class="p">)</span>


<span class="c"># 3. 合并模型的签名</span>

<span class="n">model_signature_def_map</span><span class="o">=</span><span class="p">{</span>
      <span class="s">&#39;predict_images&#39;</span><span class="p">:</span>
          <span class="n">prediction_signature</span><span class="p">,</span>
      <span class="s">&quot;serving_default&quot;</span><span class="p">:</span>
          <span class="n">classification_signature</span><span class="p">,</span>
  <span class="p">}</span>

<span class="n">legacy_init_op</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">tables_initializer</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;legacy_init_op&#39;</span><span class="p">)</span>

<span class="n">builder</span><span class="o">.</span><span class="n">add_meta_graph_and_variables</span><span class="p">(</span>
  <span class="n">sess</span><span class="p">,</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">tag_constants</span><span class="o">.</span><span class="n">SERVING</span><span class="p">],</span>
  <span class="n">signature_def_map</span><span class="o">=</span><span class="n">model_signature_def_map</span><span class="p">,</span>
  <span class="n">legacy_init_op</span><span class="o">=</span><span class="n">legacy_init_op</span>
  <span class="p">)</span>

<span class="n">builder</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>


<h5 id="16122-assets">1.6.1.2.2. 资源集合assets</h5>
<p>assets_collection用于 assets 文件处理，会帮助把指定路径文件拷贝到 SavedModel 目录下，并自动更正路径。</p>
<div class="hlcode"><pre><span class="n">asset_path_1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="s">&quot;./any_dir/&quot;</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">add_to_collection</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">GraphKeys</span><span class="o">.</span><span class="n">ASSET_FILEPATHS</span><span class="p">,</span> <span class="n">asset_path_1</span><span class="p">)</span>

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">add_meta_graph_and_variables</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;tag1&quot;</span><span class="p">],</span>
    <span class="n">signature_def_map</span><span class="o">=...</span><span class="p">,</span>
    <span class="n">assets_collection</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">GraphKeys</span><span class="o">.</span><span class="n">ASSET_FILEPATHS</span><span class="p">),</span>
    <span class="n">legacy_init_op</span><span class="o">=...</span>
  <span class="p">)</span>
</pre></div>


<h5 id="16123-legacy_init_op">1.6.1.2.3. legacy_init_op  初始化操作</h5>
<p>恢复模型操作后的初始化操作</p>
<p>legacy_init_op初始化参数在较新的 api 中应改用 main_op，平时不传值的话，会自动增加 tf.global_variables_initilizer()、tf.local_variable_initilizer() 等初始化动作，</p>
<h5 id="16124-tags">1.6.1.2.4. tags 标签</h5>
<div class="hlcode"><pre><span class="c">#Example：</span>
<span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;serve&quot;</span><span class="p">,</span> <span class="s">&quot;serve2&quot;</span><span class="p">,</span><span class="s">&quot;serve3&quot;</span><span class="p">]</span>
<span class="nb">type</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span><span class="nb">list</span> 

<span class="c">#tags输入list,list 里面是string</span>
</pre></div>


<p><strong>tag的用途</strong><br />
一个模型可以包含不同的MetaGraphDef，什么时候需要多个MetaGraphDef呢？ 也许你想保存图形的CPU版本和GPU版本，或者你想区分训练和发布版本。这个时候tag就可以用来区分不同的MetaGraphDef，加载的时候能够根据tag来加载模型的不同计算图。</p>
<p>在simple_save方法中，系统会给一个默认的tag: “serve”，也可以用<code>tag_constants.SERVING</code>这个常量。</p>
<h5 id="16125">1.6.1.2.5. 注意事项</h5>
<ol>
<li><code>export_dir</code> 为空目录<br />
值得注意的是在导出模型的时候， 必须将保存导出模型的目录<code>export_dir</code>设置为空目录， 否则会出现一个该目录巳存在的错误 ， 所以，在设置 <code>export_dir</code> 值的时候，务必要保证里面没离任何数据。</li>
</ol>
<p>上述程序同时保存3-5 个文件</p>
<div class="hlcode"><pre><span class="o">~/</span><span class="n">export_dir</span>
<span class="o">|</span><span class="n">__assets</span><span class="o">/</span>
<span class="o">|</span><span class="n">__assets</span><span class="p">.</span><span class="n">extra</span><span class="o">/</span>
<span class="o">|</span><span class="n">__saved_model</span><span class="p">.</span><span class="n">pd</span>
<span class="o">|</span><span class="n">__variables</span>
    <span class="o">|</span><span class="n">__variables</span><span class="p">.</span><span class="n">index</span>
    <span class="o">|</span><span class="n">__variables</span><span class="p">.</span><span class="n">data</span><span class="o">-</span><span class="mo">00000</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="mo">00001</span>
</pre></div>


<h3 id="162-tfestimatorsavedmodel">1.6.2. [高阶模块] tf.estimator中的savedmodel</h3>
<div class="hlcode"><pre><span class="n">estimator</span><span class="o">.</span><span class="n">export_saved_model</span><span class="p">(</span>
    <span class="n">export_dir_base</span><span class="p">,</span>
    <span class="n">serving_input_receiver_fn</span><span class="p">,</span>
    <span class="n">assets_extra</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">as_text</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">checkpoint_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">experimental_mode</span><span class="o">=</span><span class="n">ModeKeys</span><span class="o">.</span><span class="n">PREDICT</span>
<span class="p">)</span>

<span class="nb">type</span><span class="p">(</span><span class="n">serving_input_receiver_fn</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">function</span> 
</pre></div>


<p>estimator 定义了export_savedmodel的方法进行savedmodel,需要输入的参数包括: <br />
1. export_dir_base :str<br />
2. serving_input_receiver_fn :func </p>
<h4 id="serving_input_receiver_fn">serving_input_receiver_fn</h4>
<p>提供服务阶段输入数据由 serving_input_receiver_fn提供。函数返回 ServingInputReceiver，可以通过以下3种方式构建 </p>
<div class="hlcode"><pre><span class="c"># 1. 直接通过实例化类定义</span>
<span class="n">ServingInputReceiver</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">export</span><span class="o">.</span><span class="n">ServingInputReceiver</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">receiver_tensors</span><span class="p">)</span>
<span class="c"># feature,receiver_tensors 自定义</span>

<span class="c"># 2. 通过函数1定义</span>
<span class="n">ServingInputReceiver</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">export</span><span class="o">.</span><span class="n">build_raw_serving_input_receiver_fn</span><span class="p">(</span><span class="n">features</span><span class="p">)()</span>
<span class="c"># feature与receiver_tensors相同</span>


<span class="c"># 3. 通过函数2定义</span>
<span class="n">ServingInputReceiver</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">export</span><span class="o">.</span><span class="n">build_parsing_serving_input_receiver_fn</span><span class="p">(</span>
    <span class="n">feature_spec</span><span class="p">,</span>
    <span class="n">default_batch_size</span><span class="o">=</span><span class="bp">None</span>
<span class="p">)()</span>
<span class="c"># feature 自定义,receiver_tensors定死{&#39;examples&#39;: &lt;tf.Tensor &#39;input_example_tensor_2:0&#39; shape=(?,) dtype=string&gt;}</span>
</pre></div>


<!-- TODO 详细解释  -->

<p><strong>完整版本构建</strong></p>
<div class="hlcode"><pre><span class="k">def</span> <span class="nf">serving_input_receiver_fn</span><span class="p">():</span>
  <span class="sd">&quot;&quot;&quot;An input receiver that expects a serialized tf.Example.&quot;&quot;&quot;</span>
    <span class="c"># 1. 模型的输入数据 spec</span>
    <span class="n">feature_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;foo&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">(</span><span class="o">...</span><span class="p">),</span>
        <span class="s">&#39;bar&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
                <span class="p">}</span>

    <span class="c"># 2. 作为服务的模型接收的序列号 tensor</span>
    <span class="n">serialized_tf_example</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
                                            <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">default_batch_size</span><span class="p">],</span>
                                            <span class="n">name</span><span class="o">=</span><span class="s">&#39;input_example_tensor&#39;</span><span class="p">)</span>

    <span class="c"># 3. 说明数据解析的方式</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">parse_example</span><span class="p">(</span><span class="n">serialized_tf_example</span><span class="p">,</span> <span class="n">feature_spec</span><span class="p">)</span>
    <span class="c"># features={&quot;foo&quot;:&lt;tf.tensor..&gt;}</span>
    <span class="n">receiver_tensors</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;examples&#39;</span><span class="p">:</span> <span class="n">serialized_tf_example</span><span class="p">}</span>
    <span class="c"># receiver_tensors ={&quot;examples&quot;:&lt;tf.tensor..&gt;}</span>

    <span class="c">#4. 构建服务输入接收器</span>
    <span class="n">ServingInputReceiver</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">export</span><span class="o">.</span><span class="n">ServingInputReceiver</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">receiver_tensors</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ServingInputReceiver</span>



<span class="n">MAX_SEQ_LEN</span> <span class="o">=</span> <span class="mi">128</span>
<span class="k">def</span> <span class="nf">serving_input_receiver_fn</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;An input receiver that expects a serialized tf.Example.&quot;&quot;&quot;</span>
    <span class="n">reciever_tensors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;input_ids&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
                                    <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">MAX_SEQ_LEN</span><span class="p">])</span>
    <span class="p">}</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;input_ids&quot;</span><span class="p">:</span> <span class="n">reciever_tensors</span><span class="p">[</span><span class="s">&#39;input_ids&#39;</span><span class="p">],</span>
        <span class="s">&quot;input_mask&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">reciever_tensors</span><span class="p">[</span><span class="s">&#39;input_ids&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
        <span class="s">&quot;segment_ids&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
                                <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">MAX_SEQ_LEN</span><span class="p">])</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">export</span><span class="o">.</span><span class="n">ServingInputReceiver</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">reciever_tensors</span><span class="p">)</span>

<span class="n">estimator</span><span class="o">.</span><span class="n">_export_to_tpu</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">estimator</span><span class="o">.</span><span class="n">export_savedmodel</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">serving_input_receiver_fn</span><span class="p">)</span>
</pre></div>


<p><strong>函数1构建</strong></p>
<div class="hlcode"><pre><span class="k">def</span> <span class="nf">serving_input_fn</span><span class="p">():</span>
  <span class="n">feature_spec</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s">&quot;unique_ids&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([</span><span class="n">MAX_SEQ_LENGTH</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
      <span class="s">&quot;input_ids&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([</span><span class="n">MAX_SEQ_LENGTH</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
      <span class="s">&quot;input_mask&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([</span><span class="n">MAX_SEQ_LENGTH</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
      <span class="s">&quot;segment_ids&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([</span><span class="n">MAX_SEQ_LENGTH</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
      <span class="s">&quot;label_ids&quot;</span> <span class="p">:</span>  <span class="n">tf</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

  <span class="p">}</span>
  <span class="n">serialized_tf_example</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">],</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;input_example_tensor&#39;</span><span class="p">)</span>
  <span class="n">features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">parse_example</span><span class="p">(</span><span class="n">serialized_tf_example</span><span class="p">,</span> <span class="n">feature_spec</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">export</span><span class="o">.</span><span class="n">build_raw_serving_input_receiver_fn</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
</pre></div>


<h4 id="assets_extra">assets_extra</h4>
<div class="hlcode"><pre><span class="n">_assets_extra</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;my_asset_file.txt&#39;</span><span class="p">:</span> <span class="s">&#39;/path/to/my_asset_file.txt&#39;</span><span class="p">}</span>
</pre></div>


<div class="hlcode"><pre><span class="p">.</span><span class="o">/</span><span class="n">export_model</span>
<span class="o">|</span><span class="n">_assets</span>
<span class="o">|</span> <span class="o">|</span><span class="n">_</span> <span class="n">my_asset_file</span><span class="p">.</span><span class="n">txt</span>
<span class="o">|</span><span class="n">_varible</span>
<span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="p">...</span><span class="n">data</span>
<span class="o">|</span><span class="n">_model</span><span class="p">.</span><span class="n">pd</span>
</pre></div>


<h4 id="metagraph">实现多个metagraph</h4>
<div class="hlcode"><pre><span class="n">checkpoint_str</span><span class="o">=</span><span class="n">estimator</span><span class="o">.</span><span class="n">latest_checkpoint</span><span class="p">()</span>

<span class="n">saver</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">import_meta_graph</span><span class="p">(</span><span class="n">checkpoint_str</span> <span class="o">+</span> <span class="s">&#39;.meta&#39;</span><span class="p">,</span> <span class="n">clear_devices</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
  <span class="c"># 1.恢复图并得到数据</span>
  <span class="n">saver</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">checkpoint_str</span><span class="p">)</span> 
  <span class="c"># 2.build </span>
  <span class="n">builder</span><span class="o">.</span><span class="n">add_meta_graph_and_variables</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;tag1&quot;</span><span class="p">],</span>
  <span class="n">signature_def_map</span><span class="o">=</span><span class="n">model_signature_def_map1</span><span class="p">,</span>
  <span class="n">legacy_init_op</span><span class="o">=</span><span class="n">legacy_init_op</span><span class="p">)</span>

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
  <span class="c"># 1.恢复图并得到数据</span>
  <span class="n">saver</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">checkpoint_str</span><span class="p">)</span> 
  <span class="c"># 2.build </span>
  <span class="n">builder</span><span class="o">.</span><span class="n">add_meta_graph_and_variables</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;tag2&quot;</span><span class="p">],</span>
  <span class="n">signature_def_map</span><span class="o">=</span><span class="n">model_signature_def_map2</span><span class="p">,</span>
  <span class="n">legacy_init_op</span><span class="o">=</span><span class="n">legacy_init_op</span><span class="p">)</span>

<span class="n">builder</span><span class="o">.</span><span class="n">saver</span>
</pre></div>


<h3 id="163-sess-saved_model">1.6.3. [高阶模块] sess中简化版本的 saved_model</h3>
<div class="hlcode"><pre><span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">simple_save</span><span class="p">(</span>
    <span class="n">sess</span><span class="p">,</span>
    <span class="n">export_path</span><span class="p">,</span>
    <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;input_image&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">input</span><span class="p">},</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">{</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">:</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">outputs</span><span class="p">}</span>
    <span class="p">)</span>

<span class="c"># model.input: tensor </span>
<span class="c"># model.outputs:list </span>
<span class="c"># t:tensor </span>
</pre></div>


<h3 id="164-tfkeras">1.6.4. [高阶模块] tf.keras中如何实现</h3>
<div class="hlcode"><pre><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">export_saved_model</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">saved_model_path</span><span class="p">,</span>
    <span class="n">custom_objects</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">as_text</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">input_signature</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">serving_only</span><span class="o">=</span><span class="bp">False</span>
<span class="p">)</span>


<span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">filepath</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">include_optimizer</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">save_format</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="c"># &quot;tf&quot; Savedmodel</span>
    <span class="n">signatures</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">options</span><span class="o">=</span><span class="bp">None</span>
<span class="p">)</span>
</pre></div>


<h3 id="165-bazel">1.6.5. Bazel</h3>
<p>要使用 TensorFlow Serving 部署模型 ， 则需要一个必备工具一－Bazel 。 Bazel 是 一个类似于 Maven 相 Google 的开源构建和测试工具，<br />
支持多种语言的项目并且可 以为多个平台构建和输出可以直接从 Bazel的官方网站上下载最新版本，并使用如下命令进行安装。</p>
<div class="hlcode"><pre><span class="n">bazel</span> <span class="n">build</span> <span class="o">-</span> <span class="n">c</span> <span class="n">opt</span> <span class="c1">//tensorflow serving / example: mnist_saved_model</span>
<span class="n">bazel</span><span class="o">-</span><span class="n">bin</span> <span class="o">/</span> <span class="n">tensorflow_serving</span> <span class="o">/</span> <span class="n">example</span> <span class="o">/</span> <span class="n">mnist_saved_model</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">mnist_model</span> 
</pre></div>


<p>第一行的意思是将我们的训练源码进行构建，也就是训练模型的过程；<br />
第二行的意思则是将训练好的 TensorFlow 打包成一个模型文 件 3 打包后同样生成 saved_model.pb 文件和 variables 艾件夹。</p>
<p><strong>NOTE</strong><br />
虽然使用 Bazel 打包是谷歌官方推荐的 ， 但是在实际生产过程中并不常用 </p>
<h2 id="17-frozengraph">1.7. 怎么保存FrozenGraph</h2>
<h3 id="171-tfgfilegfile">1.7.1. tf.gfile.GFile()</h3>
<p>tf.gfile 是tensorflow 的文件操作库。使用 tf.gfile.GFile（）函数打包 ，将图的信息和变量信息进行保存然后写入 pb 文件中</p>
<div class="hlcode"><pre><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.python</span> <span class="nn">.</span> <span class="nn">framework</span> <span class="kn">import</span> <span class="n">graph_util</span> 
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="nn">.python</span> <span class="nn">.platform</span> <span class="kn">import</span> <span class="n">gfile</span> 

<span class="k">def</span> <span class="nf">freeze_graph</span><span class="p">(</span><span class="n">input_checkpoint</span><span class="p">,</span><span class="n">output_graph</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    :param input_checkpoint:</span>
<span class="sd">    :param output_graph: PB模型保存路径</span>
<span class="sd">    :return:</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c"># checkpoint = tf.train.get_checkpoint_state(model_folder) #检查目录下ckpt文件状态是否可用</span>
    <span class="c"># input_checkpoint = checkpoint.model_checkpoint_path #得ckpt文件路径</span>

    <span class="c"># 指定输出的节点名称,该节点名称必须是原模型中存在的节点</span>
    <span class="n">output_node_names</span> <span class="o">=</span> <span class="s">&quot;InceptionV3/Logits/SpatialSqueeze&quot;</span>
    <span class="n">saver</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">import_meta_graph</span><span class="p">(</span><span class="n">input_checkpoint</span> <span class="o">+</span> <span class="s">&#39;.meta&#39;</span><span class="p">,</span> <span class="n">clear_devices</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="n">saver</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">input_checkpoint</span><span class="p">)</span> <span class="c">#恢复图并得到数据</span>
        <span class="n">output_graph_def</span> <span class="o">=</span> <span class="n">graph_util</span><span class="o">.</span><span class="n">convert_variables_to_constants</span><span class="p">(</span>  <span class="c"># 模型持久化，将变量值固定</span>
            <span class="n">sess</span><span class="o">=</span><span class="n">sess</span><span class="p">,</span>
            <span class="n">input_graph_def</span><span class="o">=</span><span class="n">sess</span><span class="o">.</span><span class="n">graph_def</span><span class="p">,</span><span class="c"># 等于:sess.graph_def</span>
            <span class="n">output_node_names</span><span class="o">=</span><span class="n">output_node_names</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">))</span><span class="c"># 如果有多个输出节点，以逗号隔开</span>

        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">GFile</span><span class="p">(</span><span class="n">output_graph</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="c">#保存模型</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_graph_def</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span> <span class="c">#序列化输出</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s"> ops in the final graph.&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_graph_def</span><span class="o">.</span><span class="n">node</span><span class="p">))</span> <span class="c">#得到</span>
</pre></div>


<h2 id="18-tflite_model">1.8. 怎么保存 TFlite_Model</h2>
<p><img alt="" src="../../../../../attach/images/2019-10-10-10-09-00.png" /><br />
1. FrozenGraph：使用freeze_graph.py对checkpoint和GraphDef进行整合和优化，可以直接部署到Android、iOS等移动设备上。<br />
2. TFLite<br />
TFLite：基于flatbuf对模型进行优化，可以直接部署到Android、iOS等移动设备上，使用接口和FrozenGraph有些差异</p>
<div class="hlcode"><pre><span class="c"># 1 创建转换器实例Converter</span>
<span class="n">converter</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">lite</span><span class="o">.</span><span class="n">TocoConverter</span><span class="o">.</span><span class="n">from_saved_model</span><span class="p">(</span><span class="n">export_path</span><span class="p">)</span>
<span class="c"># 2. 实例设置</span>
<span class="n">converter</span><span class="o">.</span><span class="n">post_training_quantize</span><span class="o">=</span><span class="bp">True</span>
<span class="c"># 3. 生成模型</span>
<span class="n">tflite_quantized_model</span><span class="o">=</span><span class="n">converter</span><span class="o">.</span><span class="n">convert</span><span class="p">()</span>
<span class="c"># 4. 模型持久化</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;./export_model/quantized_model.tflite&quot;</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tflite_quantized_model</span><span class="p">)</span>

<span class="n">converter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">lite</span><span class="o">.</span><span class="n">TFLiteConverter</span><span class="o">.</span><span class="n">from_keras_model_file</span><span class="p">()</span>
<span class="n">tflite_model</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">convert</span><span class="p">()</span>
<span class="nb">open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">converted_model</span><span class="o">.</span><span class="n">tflite</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;,</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">wb</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tflite_model</span><span class="p">)</span>
</pre></div>


<p>转换器实例可以从多种形式创建</p>
<div class="hlcode"><pre><span class="nb">dir</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">lite</span><span class="o">.</span><span class="n">TFLiteConverter</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span>
 <span class="s">&#39;from_frozen_graph&#39;</span><span class="p">,</span>
 <span class="s">&#39;from_keras_model_file&#39;</span><span class="p">,</span>
 <span class="s">&#39;from_saved_model&#39;</span><span class="p">,</span>
 <span class="s">&#39;from_session&#39;</span><span class="p">,</span>
 <span class="o">...</span>
</pre></div>


<h1 id="2">2. 模型的加载</h1>
<h2 id="21-checkpoint_model">2.1. checkpoint_model 加载</h2>
<h4 id="211-tfsaver-restore">2.1.1. tf.saver restore</h4>
<div class="hlcode"><pre><span class="n">saver</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">import_meta_graph</span><span class="p">(</span><span class="s">&quot;save/model.ckpt.meta&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
  <span class="n">saver</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span><span class="s">&quot;output/model.ckpt&quot;</span><span class="p">)</span>
  <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>


<p>sess 必须提前加载，同时参数没有初始化，因为restore 方法本身就是一个初始化的过程<br />
1. 若使用了 tf.contrib</p>
<div class="hlcode"><pre><span class="n">tf</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">resampler</span><span class="p">()</span>
<span class="n">saver</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">import_meta_graph</span><span class="p">(</span><span class="s">&quot;save/model.ckpt.meta&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
  <span class="n">saver</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span><span class="s">&quot;save/model.ckpt&quot;</span><span class="p">)</span>
  <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>


<ol>
<li>找到最新的checkpoint</li>
</ol>
<div class="hlcode"><pre><span class="n">model_file</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">latest_checkpoint</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>

<span class="n">model_file</span>
<span class="o">&gt;&gt;&gt;</span>  <span class="nb">str</span>
<span class="s">&quot;output/model.ckpt&quot;</span>
</pre></div>


<h2 id="22-saved-mode">2.2. Saved mode 加载</h2>
<h3 id="sess">加载到sess 中</h3>
<div class="hlcode"><pre><span class="n">export_dir</span> <span class="o">=</span> <span class="o">...</span>
<span class="o">...</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">())</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
  <span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="p">[</span><span class="n">tag_constants</span><span class="o">.</span><span class="n">TRAINING</span><span class="p">],</span> <span class="n">export_dir</span><span class="p">)</span>
  <span class="o">...</span>
</pre></div>


<h3 id="keras-model">加载到keras model 中</h3>
<div class="hlcode"><pre><span class="n">new_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">load_from_saved_model</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="n">new_model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>


<h2 id="23-frozengraph">2.3. FrozenGraph 加载</h2>
<div class="hlcode"><pre><span class="c"># 1. tf.io.gfile.GFile 打开pb文件</span>
<span class="n">model_f</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">GFile</span><span class="p">(</span><span class="s">&quot;./Test/model.pb&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;rb&#39;</span><span class="p">)</span>
<span class="c"># 2 创建一个空的graph_def 类</span>
<span class="n">graph_def</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">GraphDef</span><span class="p">()</span>
<span class="c"># 3. 将 MetaGraph的二进制文件调入 空的graph_def，加载节点(Node)信息</span>
<span class="n">graph_def</span><span class="o">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="n">model_f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>  <span class="c">##二进制调用实际上是 ParseFromString</span>
<span class="c"># 4. 将graph_def调入到现在的graph 中 通过return_elements 确定返回的 op /tensor</span>
<span class="n">tensor_c</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">graph_util</span><span class="o">.</span><span class="n">import_graph_def</span><span class="p">(</span><span class="n">graph_def</span><span class="p">,</span> <span class="n">return_elements</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;add2:0&quot;</span><span class="p">])</span>

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
  <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tensor_c</span><span class="p">)</span>
</pre></div>


<h1 id="3">3. 模型转换</h1>
<h2 id="31-ckpt-pd">3.1. ckpt -&gt; pd</h2>
<p>ckpt格式转换为pd格式相当于freeze_graph操作</p>
<div class="hlcode"><pre><span class="n">input_checkpoint</span><span class="o">=</span><span class="s">&quot;./model/model.ckpt-0&quot;</span>
<span class="n">output_graph</span><span class="o">=</span><span class="s">&quot;./model/saved_model.pd&quot;</span>

<span class="k">def</span> <span class="nf">freeze_graph</span><span class="p">(</span><span class="n">input_checkpoint</span><span class="p">,</span><span class="n">output_graph</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Args:</span>
<span class="sd">      param input_checkpoint:</span>
<span class="sd">      param output_graph: PB模型保存路径</span>
<span class="sd">    Returns:</span>
<span class="sd">      None</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c"># checkpoint = tf.train.get_checkpoint_state(model_folder) #检查目录下ckpt文件状态是否可用</span>
    <span class="c"># input_checkpoint = checkpoint.model_checkpoint_path #得ckpt文件路径</span>

    <span class="c"># 指定输出的节点名称,该节点名称必须是原模型中存在的节点</span>
    <span class="n">output_node_names</span> <span class="o">=</span> <span class="s">&quot;InceptionV3/Logits/SpatialSqueeze&quot;</span>
    <span class="n">saver</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">import_meta_graph</span><span class="p">(</span><span class="n">input_checkpoint</span> <span class="o">+</span> <span class="s">&#39;.meta&#39;</span><span class="p">,</span> <span class="n">clear_devices</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="n">saver</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">input_checkpoint</span><span class="p">)</span> <span class="c">#恢复图并得到数据</span>
        <span class="n">output_graph_def</span> <span class="o">=</span> <span class="n">graph_util</span><span class="o">.</span><span class="n">convert_variables_to_constants</span><span class="p">(</span>  <span class="c"># 模型持久化，将变量值固定</span>
            <span class="n">sess</span><span class="o">=</span><span class="n">sess</span><span class="p">,</span>
            <span class="n">input_graph_def</span><span class="o">=</span><span class="n">sess</span><span class="o">.</span><span class="n">graph_def</span><span class="p">,</span><span class="c"># 等于:sess.graph_def</span>
            <span class="n">output_node_names</span><span class="o">=</span><span class="n">output_node_names</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">))</span><span class="c"># 如果有多个输出节点，以逗号隔开</span>

        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">GFile</span><span class="p">(</span><span class="n">output_graph</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="c">#保存模型</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_graph_def</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span> <span class="c">#序列化输出</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s"> ops in the final graph.&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_graph_def</span><span class="o">.</span><span class="n">node</span><span class="p">))</span> <span class="c">#得到当前图有几个操作节点</span>
</pre></div>


<h2 id="32-h5-pd">3.2. h5 -&gt;pd</h2>
<p>如果想在生产环境中使用keras框架产生的hdf5格式的模型文件，也需要将其转换为pb格式，怎么做呢？</p>
<div class="hlcode"><pre><span class="k">def</span> <span class="nf">freeze_session</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">keep_var_names</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">output_names</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">clear_devices</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Freezes the state of a session into a prunned computation graph.</span>
<span class="sd">Creates a new computation graph where variable nodes are replaced by</span>
<span class="sd">    constants taking their current value in the session. The new graph will be</span>
<span class="sd">    prunned so subgraphs that are not neccesary to compute the requested</span>
<span class="sd">    outputs are removed.</span>
<span class="sd">    @param session The TensorFlow session to be frozen.</span>
<span class="sd">    @param keep_var_names A list of variable names that should not be frozen,</span>
<span class="sd">                          or None to freeze all the variables in the graph.</span>
<span class="sd">    @param output_names Names of the relevant graph outputs.</span>
<span class="sd">    @param clear_devices Remove the device directives from the graph for better portability.</span>
<span class="sd">    @return The frozen graph definition.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">tensorflow.python.framework.graph_util</span> <span class="kn">import</span> <span class="n">convert_variables_to_constants</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">graph</span>
    <span class="k">with</span> <span class="n">graph</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
        <span class="n">freeze_var_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">global_variables</span><span class="p">())</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">keep_var_names</span> <span class="ow">or</span> <span class="p">[]))</span>
        <span class="n">output_names</span> <span class="o">=</span> <span class="n">output_names</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">output_names</span> <span class="o">+=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">global_variables</span><span class="p">()]</span>
        <span class="n">input_graph_def</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">as_graph_def</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">clear_devices</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">input_graph_def</span><span class="o">.</span><span class="n">node</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">frozen_graph</span> <span class="o">=</span> <span class="n">convert_variables_to_constants</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">input_graph_def</span><span class="p">,</span>
                                                      <span class="n">output_names</span><span class="p">,</span> <span class="n">freeze_var_names</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frozen_graph</span>

<span class="n">input_fld</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">weight_file</span> <span class="o">=</span> <span class="s">&#39;vgg16_without_dropout.h5&#39;</span>
<span class="n">output_graph_name</span> <span class="o">=</span> <span class="s">&#39;vgg16_without_dropout.pb&#39;</span>
<span class="n">output_fld</span> <span class="o">=</span> <span class="n">input_fld</span> <span class="o">+</span> <span class="s">&#39;/tensorflow_model/&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">output_fld</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_fld</span><span class="p">)</span>
<span class="n">weight_file_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_fld</span><span class="p">,</span> <span class="n">weight_file</span><span class="p">)</span>
<span class="n">K</span><span class="o">.</span><span class="n">set_learning_phase</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">net_model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">weight_file_path</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">&#39;input is :&#39;</span><span class="p">,</span> <span class="n">net_model</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">print</span> <span class="p">(</span><span class="s">&#39;output is:&#39;</span><span class="p">,</span> <span class="n">net_model</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span>
<span class="n">frozen_graph</span> <span class="o">=</span> <span class="n">freeze_session</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">get_session</span><span class="p">(),</span> <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="n">net_model</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
<span class="kn">from</span> <span class="nn">tensorflow.python.framework</span> <span class="kn">import</span> <span class="n">graph_io</span>
<span class="n">graph_io</span><span class="o">.</span><span class="n">write_graph</span><span class="p">(</span><span class="n">frozen_graph</span><span class="p">,</span> <span class="n">output_fld</span><span class="p">,</span> <span class="n">output_graph_name</span><span class="p">,</span> <span class="n">as_text</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">&#39;saved the constant graph (ready for inference) at: &#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_fld</span><span class="p">,</span> <span class="n">output_graph_name</span><span class="p">))</span>
</pre></div>


<div class="hlcode"><pre><span class="n">full_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="c"># full_model = tf.function(lambda Input: model(Input))</span>
<span class="n">full_model</span> <span class="o">=</span> <span class="n">full_model</span><span class="o">.</span><span class="n">get_concrete_function</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">TensorSpec</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>

<span class="n">frozen_func</span> <span class="o">=</span> <span class="n">convert_variables_to_constants_v2</span><span class="p">(</span><span class="n">full_model</span><span class="p">)</span>
<span class="n">frozen_func</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">as_graph_def</span><span class="p">()</span>

<span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">frozen_func</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_operations</span><span class="p">()]</span>
<span class="k">print</span><span class="p">(</span><span class="s">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">&quot;Frozen model layers: &quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">&quot;Frozen model inputs: &quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">frozen_func</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">&quot;Frozen model outputs: &quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">frozen_func</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span>

<span class="c"># Save frozen graph from frozen ConcreteFunction to hard drive</span>
<span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_graph</span><span class="p">(</span><span class="n">graph_or_graph_def</span><span class="o">=</span><span class="n">frozen_func</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span>
                  <span class="n">logdir</span><span class="o">=</span><span class="s">&quot;./model&quot;</span><span class="p">,</span>
                  <span class="n">name</span><span class="o">=</span><span class="s">&quot;model.pb&quot;</span><span class="p">,</span>
                  <span class="n">as_text</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>


<h2 id="frozengraph-savedmodel">FrozenGraph-&gt;SavedModel</h2>
<div class="hlcode"><pre><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.python.saved_model</span> <span class="kn">import</span> <span class="n">signature_constants</span>
<span class="kn">from</span> <span class="nn">tensorflow.python.saved_model</span> <span class="kn">import</span> <span class="n">tag_constants</span>

<span class="n">export_dir</span> <span class="o">=</span> <span class="s">&#39;./saved&#39;</span>
<span class="n">graph_pb</span> <span class="o">=</span> <span class="s">&#39;my_quant_graph.pb&#39;</span>

<span class="n">builder</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">SavedModelBuilder</span><span class="p">(</span><span class="n">export_dir</span><span class="p">)</span>

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">GFile</span><span class="p">(</span><span class="n">graph_pb</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">graph_def</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">GraphDef</span><span class="p">()</span>
    <span class="n">graph_def</span><span class="o">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="n">sigs</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">())</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="c"># name=&quot;&quot; is important to ensure we don&#39;t get spurious prefixing</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">import_graph_def</span><span class="p">(</span><span class="n">graph_def</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span>
    <span class="n">inp</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s">&quot;real_A_and_B_images:0&quot;</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s">&quot;generator/Tanh:0&quot;</span><span class="p">)</span>

    <span class="n">sigs</span><span class="p">[</span><span class="n">signature_constants</span><span class="o">.</span><span class="n">DEFAULT_SERVING_SIGNATURE_DEF_KEY</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">signature_def_utils</span><span class="o">.</span><span class="n">predict_signature_def</span><span class="p">(</span>
            <span class="p">{</span><span class="s">&quot;in&quot;</span><span class="p">:</span> <span class="n">inp</span><span class="p">},</span> <span class="p">{</span><span class="s">&quot;out&quot;</span><span class="p">:</span> <span class="n">out</span><span class="p">})</span>

    <span class="n">builder</span><span class="o">.</span><span class="n">add_meta_graph_and_variables</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span>
                                         <span class="p">[</span><span class="n">tag_constants</span><span class="o">.</span><span class="n">SERVING</span><span class="p">],</span>
                                         <span class="n">signature_def_map</span><span class="o">=</span><span class="n">sigs</span><span class="p">)</span>

<span class="n">builder</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>


<p>*<sup id="fnref2:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup></p>
<h1 id="5">5. 参考资料</h1>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>https://www.tensorflow.org/guide/saved_model&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a><a class="footnote-backref" href="#fnref2:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
</div>
<div id="renote">
  <HR style=" FILTER: alpha (opacity = 100, finishopacity =0 , style= 3 )" width="80%" color=#987 cb 9 SIZE=3>
  <p>如果你觉得这篇文章对你有帮助，不妨请我喝杯咖啡，鼓励我创造更多!</p>
  <img src="/Wiki/static/images/pay.jpg" width="25%">
</div>

    </div>
    <div id="footer">
        <span>
            Copyright © 2021 zhang787jun.
            Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
        </span>
    </div>

    
</body>
<script>
    function changeImgurl(site_root_url) {
        var images = document.images;
        var site_root = site_root_url;
        for (i = 0, len = images.length; i < len; i++) {
            image = images[i];
            image_src = image.src;
            if (image_src.search("attach") >= 0) {
                re_image_src = image_src.slice(image_src.search("attach"));
                abs_image_src = (site_root.endsWith("/")) ? site_root + re_image_src : site_root + "/" +
                    re_image_src;
                image.src = abs_image_src;
            }
        }
    }
    var site_root_url = "/Wiki";
    changeImgurl(site_root_url);
    let isMathjaxConfig = false; // 防止重复调用Config，造成性能损耗
    const initMathjaxConfig = () => {
        if (!window.MathJax) {
            return;
        }
        window.MathJax.Hub.Config({
            showProcessingMessages: false, //关闭js加载过程信息
            messageStyle: "none", //不显示信息
            jax: ["input/TeX", "output/HTML-CSS"],
            tex2jax: {
                inlineMath: [["$", "$"], ["\\(", "\\)"]], //行内公式选择符
                displayMath: [["$$", "$$"], ["\\[", "\\]"]], //段内公式选择符
                skipTags: ["script", "noscript", "style", "textarea", "pre", "code", "a"] //避开某些标签
            },
            "HTML-CSS": {
                availableFonts: ["STIX", "TeX"], //可选字体
                showMathMenu: false //关闭右击菜单显示
            }
        });
        isMathjaxConfig = true; //
    };
    if (isMathjaxConfig === false) {
        // 如果：没有配置MathJax
        initMathjaxConfig();
    };
</script>

</html>