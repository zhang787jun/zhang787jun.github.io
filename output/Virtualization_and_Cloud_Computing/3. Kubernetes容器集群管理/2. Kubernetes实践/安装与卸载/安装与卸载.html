<!DOCTYPE HTML>
<html>

<head>
    <link rel="Stylesheet" type="text/css" href="/Wiki/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/Wiki/static/css/tango.css">
    <link rel="shortcut icon" href="/Wiki/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/Wiki/favicon.ico" type="image/x-icon">
    <title>k8s 安装与卸载 - Jun's personal knowledge wiki</title>
    <meta name="keywords" content="Technology, MachineLearning, DataMining, Wiki" />
    <meta name="description" content="A wiki website" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
            }
        });
    </script>
    <script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
        </script>
</head>

<body>

    <div id="container">
        
<div id="header">
  <div id="post-nav"><a href="/Wiki/">Home</a>&nbsp;»&nbsp;<a href="/Wiki/#Virtualization_and_Cloud_Computing\3. Kubernetes容器集群管理\2. Kubernetes实践\安装与卸载">Virtualization_and_Cloud_Computing\3. Kubernetes容器集群管理\2. Kubernetes实践\安装与卸载</a>&nbsp;»&nbsp;k8s 安装与卸载</div>
</div>
<div class="clearfix"></div>
<div id="title">k8s 安装与卸载</div>
<div id="content">
  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#1">1. 安装</a><ul>
<li><a href="#11">1.1. 安装前提</a></li>
<li><a href="#12-for-all-nodes">1.2. 安装组件 For all nodes</a></li>
<li><a href="#13-master">1.3. 初始化集群控制平台节点 master</a></li>
<li><a href="#14-pod">1.4. 安装pod网络插件</a><ul>
<li><a href="#141-flannel">1.4.1. 使用 flannel插件</a></li>
</ul>
</li>
<li><a href="#15-worknode">1.5. Worknode 加入</a></li>
<li><a href="#16">1.6. 安装遇到的问题汇总</a><ul>
<li><a href="#161-not-ready">1.6.1. not-ready</a></li>
</ul>
</li>
<li><a href="#17">1.7. 其他</a><ul>
<li><a href="#171-cgroups">1.7.1. 进程对硬件资源使用的限制(cgroups)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_1">第三方管理安装工具</a></li>
<li><a href="#2">2. 卸载</a></li>
<li><a href="#kuberneters">公有云上部署 kuberneters</a></li>
</ul>
</div>
<h1 id="1">1. 安装</h1>
<h2 id="11">1.1. 安装前提</h2>
<ol>
<li>一台或多台运行以下其中一项的计算机：<br />
    Ubuntu 16.04以上<br />
    Debian 9+<br />
    CentOS的7<br />
    红帽企业Linux（RHEL）7<br />
    Fedora 25+<br />
    HypriotOS v1.0.1 +<br />
    容器Linux（已通过1800.6.0测试）</li>
<li>每台机器2 GB或更多的RAM（更少的空间将为您的应用程序留出很少的空间）</li>
<li>2个或更多CPU</li>
<li>群集中所有计算机之间的完整网络连接（可以使用公用或专用网络）</li>
<li>每个节点的唯一主机名，MACqi和product_uuid。有关更多详细信息，请参见此处。</li>
<li>某些端口在您的计算机上打开。有关更多详细信息，请参见此处。</li>
<li>交换已禁用。您必须禁用交换才能使kubelet正常工作。</li>
</ol>
<div class="hlcode"><pre><span class="cp"># 临时禁用</span>
<span class="n">sudo</span> <span class="n">swapoff</span> <span class="o">-</span><span class="n">a</span>

<span class="cp"># 永久禁用</span>
<span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s">&quot;/ swap / s/^/#/&quot;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fstab</span>
<span class="n">sudo</span> <span class="n">swapoff</span> <span class="o">-</span><span class="n">a</span>
</pre></div>


<ol>
<li>关闭防火墙</li>
</ol>
<div class="hlcode"><pre><span class="n">sudo</span> <span class="n">ufw</span> <span class="n">disable</span>
</pre></div>


<h2 id="12-for-all-nodes">1.2. 安装组件 For all nodes</h2>
<p>集群中的<strong>所有节点</strong>需要安装 1.<code>kubeadm</code> ,2.<code>kubelet</code> , 3.<code>kubectl</code> 4.<code>docker</code>：<br />
<code>kubeadm</code>: 引导启动集群的 the command to bootstrap the cluster.<br />
<code>kubelet</code>: 再所有节点上执行启动pod及容器的组件 the component that runs on all of the machines in your cluster and does things like starting pods and containers.<br />
<code>kubectl</code>: 与集群沟通工具 the command line util to talk to your cluster.</p>
<div class="hlcode"><pre><span class="cp"># 国内建议更换镜像 </span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">apt</span><span class="o">-</span><span class="n">transport</span><span class="o">-</span><span class="n">https</span>
<span class="n">curl</span> <span class="n">https</span><span class="o">:</span><span class="c1">//mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -</span>
<span class="n">cat</span> <span class="o">&lt;&lt;</span><span class="n">EOF</span> <span class="o">&gt;/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="p">.</span><span class="n">list</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">list</span>
<span class="n">deb</span> <span class="n">https</span><span class="o">:</span><span class="c1">//mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span>
<span class="n">EOF</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="cp"># 安装 kubelet kubeadm kubectl</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">kubelet</span><span class="o">=</span><span class="mf">1.15.0</span><span class="o">-</span><span class="mo">00</span> <span class="n">kubeadm</span><span class="o">=</span><span class="mf">1.15.0</span><span class="o">-</span><span class="mo">00</span>  <span class="n">kubectl</span><span class="o">=</span><span class="mf">1.15.0</span><span class="o">-</span><span class="mo">00</span> 
<span class="cp"># 标记该软件包不被自动更新</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">mark</span> <span class="n">hold</span> <span class="n">kubelet</span> <span class="n">kubeadm</span> <span class="n">kubectl</span>
<span class="cp"># 安装docker</span>
<span class="n">curl</span> <span class="o">-</span><span class="n">fsSL</span> <span class="n">https</span><span class="o">:</span><span class="c1">//get.docker.com | bash -s docker --mirror Aliyun</span>


<span class="cp">#--------------------</span>
<span class="cp">### 官方指令</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">apt</span><span class="o">-</span><span class="n">transport</span><span class="o">-</span><span class="n">https</span> <span class="n">curl</span>
<span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="n">https</span><span class="o">:</span><span class="c1">//packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -</span>
<span class="n">cat</span> <span class="o">&lt;&lt;</span><span class="n">EOF</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">tee</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="p">.</span><span class="n">list</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">list</span>
<span class="n">deb</span> <span class="n">https</span><span class="o">:</span><span class="c1">//apt.kubernetes.io/ kubernetes-xenial main</span>
<span class="n">EOF</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="cp"># 安装 kubelet kubeadm kubectl</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">kubelet</span> <span class="n">kubeadm</span> <span class="n">kubectl</span>  
<span class="cp"># 标记该软件包不被自动更新</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">mark</span> <span class="n">hold</span> <span class="n">kubelet</span> <span class="n">kubeadm</span> <span class="n">kubectl</span>
</pre></div>


<div class="hlcode"><pre><span class="n">systemctl</span> <span class="n">enable</span> <span class="n">kubelet</span>
</pre></div>


<h2 id="13-master">1.3. 初始化集群控制平台节点 master</h2>
<div class="hlcode"><pre><span class="cp"># 官方指令</span>
<span class="n">kubeadm</span> <span class="n">init</span>

<span class="cp">#-------推荐方案</span>
<span class="cp"># 先使用国内镜像先pull images </span>
<span class="n">kubeadm</span> <span class="n">config</span> <span class="n">images</span> <span class="n">pull</span> <span class="o">--</span><span class="n">image</span><span class="o">-</span><span class="n">repository</span><span class="o">=</span><span class="n">registry</span><span class="p">.</span><span class="n">aliyuncs</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">google_containers</span>
<span class="cp"># 初始化(flannel 插件)</span>
<span class="n">kubeadm</span> <span class="n">init</span> <span class="o">--</span><span class="n">pod</span><span class="o">-</span><span class="n">network</span><span class="o">-</span><span class="n">cidr</span><span class="o">=</span><span class="mf">10.244.0.0</span><span class="o">/</span><span class="mi">16</span> <span class="o">--</span><span class="n">image</span><span class="o">-</span><span class="n">repository</span><span class="o">=</span><span class="n">registry</span><span class="p">.</span><span class="n">aliyuncs</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">google_containers</span> <span class="o">--</span><span class="n">apiserver</span><span class="o">-</span><span class="n">bind</span><span class="o">-</span><span class="n">port</span><span class="o">=</span><span class="mi">6443</span>
</pre></div>


<p>初始化之后会显示如下内容：</p>
<div class="hlcode"><pre><span class="n">Your</span> <span class="n">Kubernetes</span> <span class="n">control</span><span class="o">-</span><span class="n">plane</span> <span class="n">has</span> <span class="n">initialized</span> <span class="n">successfully</span><span class="o">!</span>

<span class="n">To</span> <span class="n">start</span> <span class="n">using</span> <span class="n">your</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">you</span> <span class="n">need</span> <span class="n">to</span> <span class="n">run</span> <span class="n">the</span> <span class="n">following</span> <span class="n">as</span> <span class="n">a</span> <span class="n">regular</span> <span class="n">user</span><span class="o">:</span>

  <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="err">$</span><span class="n">HOME</span><span class="o">/</span><span class="p">.</span><span class="n">kube</span>
  <span class="n">sudo</span> <span class="n">cp</span> <span class="o">-</span><span class="n">i</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">admin</span><span class="p">.</span><span class="n">conf</span> <span class="err">$</span><span class="n">HOME</span><span class="o">/</span><span class="p">.</span><span class="n">kube</span><span class="o">/</span><span class="n">config</span>
  <span class="n">sudo</span> <span class="n">chown</span> <span class="err">$</span><span class="p">(</span><span class="n">id</span> <span class="o">-</span><span class="n">u</span><span class="p">)</span><span class="o">:</span><span class="err">$</span><span class="p">(</span><span class="n">id</span> <span class="o">-</span><span class="n">g</span><span class="p">)</span> <span class="err">$</span><span class="n">HOME</span><span class="o">/</span><span class="p">.</span><span class="n">kube</span><span class="o">/</span><span class="n">config</span>

<span class="n">You</span> <span class="n">should</span> <span class="n">now</span> <span class="n">deploy</span> <span class="n">a</span> <span class="n">pod</span> <span class="n">network</span> <span class="n">to</span> <span class="n">the</span> <span class="n">cluster</span><span class="p">.</span>
<span class="n">Run</span> <span class="s">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> <span class="n">with</span> <span class="n">one</span> <span class="n">of</span> <span class="n">the</span> <span class="n">options</span> <span class="n">listed</span> <span class="n">at</span><span class="o">:</span>
  <span class="nl">https:</span><span class="c1">//kubernetes.io/docs/concepts/cluster-administration/addons/</span>

<span class="n">Then</span> <span class="n">you</span> <span class="n">can</span> <span class="n">join</span> <span class="n">any</span> <span class="n">number</span> <span class="n">of</span> <span class="n">worker</span> <span class="n">nodes</span> <span class="n">by</span> <span class="n">running</span> <span class="n">the</span> <span class="n">following</span> <span class="n">on</span> <span class="n">each</span> <span class="n">as</span> <span class="n">root</span><span class="o">:</span>

<span class="n">kubeadm</span> <span class="n">join</span> <span class="mf">172.24.195.42</span><span class="o">:</span><span class="mi">6443</span> <span class="o">--</span><span class="n">token</span> <span class="n">bdibtv</span><span class="mf">.8</span><span class="n">iu07mfcpssfdrmg</span> \
    <span class="o">--</span><span class="n">discovery</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">hash</span> <span class="n">sha256</span><span class="o">:</span><span class="mi">6732957</span><span class="n">bd86580ac23b70bb7a1a0135149db580e3f25a7ce24c4c1409cd5b923</span>
</pre></div>


<p>如果期望以常规用户（运行，执行以下命令 ：</p>
<div class="hlcode"><pre><span class="cp">#root用户也要</span>
<span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="err">$</span><span class="n">HOME</span><span class="o">/</span><span class="p">.</span><span class="n">kube</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="o">-</span><span class="n">i</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">admin</span><span class="p">.</span><span class="n">conf</span> <span class="err">$</span><span class="n">HOME</span><span class="o">/</span><span class="p">.</span><span class="n">kube</span><span class="o">/</span><span class="n">config</span>
<span class="n">sudo</span> <span class="n">chown</span> <span class="err">$</span><span class="p">(</span><span class="n">id</span> <span class="o">-</span><span class="n">u</span><span class="p">)</span><span class="o">:</span><span class="err">$</span><span class="p">(</span><span class="n">id</span> <span class="o">-</span><span class="n">g</span><span class="p">)</span> <span class="err">$</span><span class="n">HOME</span><span class="o">/</span><span class="p">.</span><span class="n">kube</span><span class="o">/</span><span class="n">config</span>
</pre></div>


<p>if you are the root user, you can run:</p>
<div class="hlcode"><pre><span class="n">export</span> <span class="n">KUBECONFIG</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">admin</span><span class="p">.</span><span class="n">conf</span>
</pre></div>


<p>使用<code>kubeadm init</code>设置集群时，要记住几点，并且在Kubernetes站点kubeadm cluster create上有明确记录：</p>
<ol>
<li>如果您已经创建了先前的集群，则 <code>kubeadm reset</code></li>
<li>从主目录或根目录中删除<code>.kube</code>文件夹（也可以使用systemctl停止kubelet，以实现平稳设置）</li>
<li>永久禁用计算机上的交换<code>swap</code>，尤其是在重新引导Linux系统时</li>
<li>别忘了，根据网站上（不是Kubernetes网站）上提供的说明安装 a pod network add-on 插件。</li>
<li>遵循kubeadm在命令窗口上给出的后期初始化步骤。</li>
</ol>
<div class="hlcode"><pre><span class="n">docker</span> <span class="n">images</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="n">registry</span><span class="p">.</span><span class="n">aliyuncs</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">google_containers</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">proxy</span>                <span class="n">v1</span><span class="mf">.17.0</span>             <span class="mi">7</span><span class="n">d54289267dc</span>        <span class="mi">10</span> <span class="n">days</span> <span class="n">ago</span>         <span class="mi">116</span><span class="n">MB</span>
<span class="n">registry</span><span class="p">.</span><span class="n">aliyuncs</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">google_containers</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">scheduler</span>            <span class="n">v1</span><span class="mf">.17.0</span>             <span class="mi">78</span><span class="n">c190f736b1</span>        <span class="mi">10</span> <span class="n">days</span> <span class="n">ago</span>         <span class="mf">94.4</span><span class="n">MB</span>
<span class="n">registry</span><span class="p">.</span><span class="n">aliyuncs</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">google_containers</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span>            <span class="n">v1</span><span class="mf">.17.0</span>             <span class="mi">0</span><span class="n">cae8d5cc64c</span>        <span class="mi">10</span> <span class="n">days</span> <span class="n">ago</span>         <span class="mi">171</span><span class="n">MB</span>
<span class="n">registry</span><span class="p">.</span><span class="n">aliyuncs</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">google_containers</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="n">manager</span>   <span class="n">v1</span><span class="mf">.17.0</span>             <span class="mi">5</span><span class="n">eb3b7486872</span>        <span class="mi">10</span> <span class="n">days</span> <span class="n">ago</span>         <span class="mi">161</span><span class="n">MB</span>
<span class="n">registry</span><span class="p">.</span><span class="n">aliyuncs</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">google_containers</span><span class="o">/</span><span class="n">coredns</span>                   <span class="mf">1.6.5</span>               <span class="mf">70f</span><span class="mi">311871</span><span class="n">ae1</span>        <span class="mi">6</span> <span class="n">weeks</span> <span class="n">ago</span>         <span class="mf">41.6</span><span class="n">MB</span>
<span class="n">registry</span><span class="p">.</span><span class="n">aliyuncs</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">google_containers</span><span class="o">/</span><span class="n">etcd</span>                      <span class="mf">3.4.3</span><span class="o">-</span><span class="mi">0</span>             <span class="mi">303</span><span class="n">ce5db0e90</span>        <span class="mi">7</span> <span class="n">weeks</span> <span class="n">ago</span>         <span class="mi">288</span><span class="n">MB</span>
<span class="n">registry</span><span class="p">.</span><span class="n">aliyuncs</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">google_containers</span><span class="o">/</span><span class="n">pause</span>                     <span class="mf">3.1</span>                 <span class="n">da86e6ba6ca1</span>        <span class="mi">24</span> <span class="n">months</span> <span class="n">ago</span>       <span class="mi">742</span><span class="n">kB</span>
</pre></div>


<p>另外，请不要忘记执行以下命令以在创建的集群上启用调度</p>
<div class="hlcode"><pre><span class="n">kubectl</span> <span class="n">taint</span> <span class="n">nodes</span> <span class="o">--</span><span class="n">all</span> <span class="n">node</span><span class="o">-</span><span class="n">role</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">master</span><span class="o">-</span>
</pre></div>


<h2 id="14-pod">1.4. 安装pod网络插件</h2>
<p>使用kubectl选择合适的网络组件</p>
<div class="hlcode"><pre><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="o">&lt;</span><span class="n">add</span><span class="o">-</span><span class="n">on</span><span class="p">.</span><span class="n">yaml</span><span class="o">&gt;</span>
</pre></div>


<p>每个群集<strong>只能</strong>安装一种pod网络插件，且每个群集<strong>必需</strong>有一个pod网络插件，使得pods之间可以通讯</p>
<h3 id="141-flannel">1.4.1. 使用 flannel插件</h3>
<p>要求：</p>
<ol>
<li>再执行 <code>kubeadm init</code> 时添加<code>--pod-network-cidr=10.244.0.0/16</code>参数</li>
</ol>
<p>For flannel to work correctly, you <strong>must</strong> pass --pod-network-cidr=10.244.0.0/16 to kubeadm init.</p>
<div class="hlcode"><pre><span class="cp"># kubeadm init --pod-network-cidr=10.244.0.0/16</span>
<span class="n">kubeadm</span> <span class="n">init</span> <span class="o">--</span><span class="n">pod</span><span class="o">-</span><span class="n">network</span><span class="o">-</span><span class="n">cidr</span><span class="o">=</span><span class="mf">10.244.0.0</span><span class="o">/</span><span class="mi">16</span> <span class="o">--</span><span class="n">image</span><span class="o">-</span><span class="n">repository</span><span class="o">=</span><span class="n">registry</span><span class="p">.</span><span class="n">aliyuncs</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">google_containers</span> <span class="o">--</span><span class="n">apiserver</span><span class="o">-</span><span class="n">bind</span><span class="o">-</span><span class="n">port</span><span class="o">=</span><span class="mi">6443</span>
</pre></div>


<ol>
<li>设IPv4流量通过路由表</li>
</ol>
<div class="hlcode"><pre><span class="n">sysctl</span> <span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge</span><span class="o">-</span><span class="n">nf</span><span class="o">-</span><span class="n">call</span><span class="o">-</span><span class="n">iptables</span><span class="o">=</span><span class="mi">1</span> 
</pre></div>


<ol>
<li>确保防火墙规则允许参与覆盖网络的所有主机的UDP端口8285和8472通信</li>
</ol>
<div class="hlcode"><pre><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="o">:</span><span class="c1">//raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml</span>
</pre></div>


<p>基于阿里云镜像的kube-flannel 配置文件，参考<a href="https://github.com/coreos/flannel/blob/master/Documentation/kube-flannel-aliyun.yml">github</a></p>
<div class="hlcode"><pre><span class="o">---</span>
<span class="nl">kind:</span> <span class="n">ClusterRole</span>
<span class="nl">apiVersion:</span> <span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1beta1</span>
<span class="nl">metadata:</span>
  <span class="nl">name:</span> <span class="n">flannel</span>
<span class="nl">rules:</span>
  <span class="o">-</span> <span class="n">apiGroups</span><span class="o">:</span>
      <span class="o">-</span> <span class="s">&quot;&quot;</span>
    <span class="nl">resources:</span>
      <span class="o">-</span> <span class="n">pods</span>
    <span class="nl">verbs:</span>
      <span class="o">-</span> <span class="n">get</span>
  <span class="o">-</span> <span class="n">apiGroups</span><span class="o">:</span>
      <span class="o">-</span> <span class="s">&quot;&quot;</span>
    <span class="nl">resources:</span>
      <span class="o">-</span> <span class="n">nodes</span>
    <span class="nl">verbs:</span>
      <span class="o">-</span> <span class="n">list</span>
      <span class="o">-</span> <span class="n">watch</span>
  <span class="o">-</span> <span class="n">apiGroups</span><span class="o">:</span>
      <span class="o">-</span> <span class="s">&quot;&quot;</span>
    <span class="nl">resources:</span>
      <span class="o">-</span> <span class="n">nodes</span><span class="o">/</span><span class="n">status</span>
    <span class="nl">verbs:</span>
      <span class="o">-</span> <span class="n">patch</span>
<span class="o">---</span>
<span class="nl">kind:</span> <span class="n">ClusterRoleBinding</span>
<span class="nl">apiVersion:</span> <span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1beta1</span>
<span class="nl">metadata:</span>
  <span class="nl">name:</span> <span class="n">flannel</span>
<span class="nl">roleRef:</span>
  <span class="nl">apiGroup:</span> <span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span>
  <span class="nl">kind:</span> <span class="n">ClusterRole</span>
  <span class="nl">name:</span> <span class="n">flannel</span>
<span class="nl">subjects:</span>
<span class="o">-</span> <span class="n">kind</span><span class="o">:</span> <span class="n">ServiceAccount</span>
  <span class="nl">name:</span> <span class="n">flannel</span>
  <span class="nl">namespace:</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
<span class="o">---</span>
<span class="nl">apiVersion:</span> <span class="n">v1</span>
<span class="nl">kind:</span> <span class="n">ServiceAccount</span>
<span class="nl">metadata:</span>
  <span class="nl">name:</span> <span class="n">flannel</span>
  <span class="nl">namespace:</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
<span class="o">---</span>
<span class="nl">kind:</span> <span class="n">ConfigMap</span>
<span class="nl">apiVersion:</span> <span class="n">v1</span>
<span class="nl">metadata:</span>
  <span class="nl">name:</span> <span class="n">kube</span><span class="o">-</span><span class="n">flannel</span><span class="o">-</span><span class="n">cfg</span>
  <span class="nl">namespace:</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
  <span class="nl">labels:</span>
    <span class="nl">tier:</span> <span class="n">node</span>
    <span class="nl">app:</span> <span class="n">flannel</span>
<span class="nl">data:</span>
  <span class="n">cni</span><span class="o">-</span><span class="n">conf</span><span class="p">.</span><span class="n">json</span><span class="o">:</span> <span class="o">|</span>
    <span class="p">{</span>
      <span class="s">&quot;name&quot;</span><span class="o">:</span> <span class="s">&quot;cbr0&quot;</span><span class="p">,</span>
      <span class="s">&quot;cniVersion&quot;</span><span class="o">:</span> <span class="s">&quot;0.3.1&quot;</span><span class="p">,</span>
      <span class="s">&quot;type&quot;</span><span class="o">:</span> <span class="s">&quot;flannel&quot;</span><span class="p">,</span>
      <span class="s">&quot;delegate&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s">&quot;hairpinMode&quot;</span><span class="o">:</span> <span class="nb">true</span><span class="p">,</span>
        <span class="s">&quot;isDefaultGateway&quot;</span><span class="o">:</span> <span class="nb">true</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="n">net</span><span class="o">-</span><span class="n">conf</span><span class="p">.</span><span class="n">json</span><span class="o">:</span> <span class="o">|</span>
    <span class="p">{</span>
      <span class="s">&quot;Network&quot;</span><span class="o">:</span> <span class="s">&quot;10.24.0.0/16&quot;</span><span class="p">,</span>
      <span class="s">&quot;Backend&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s">&quot;Type&quot;</span><span class="o">:</span> <span class="s">&quot;ali-vpc&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
<span class="o">---</span>
<span class="nl">apiVersion:</span> <span class="n">extensions</span><span class="o">/</span><span class="n">v1beta1</span>
<span class="nl">kind:</span> <span class="n">DaemonSet</span>
<span class="nl">metadata:</span>
  <span class="nl">name:</span> <span class="n">kube</span><span class="o">-</span><span class="n">flannel</span><span class="o">-</span><span class="n">ds</span>
  <span class="nl">namespace:</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
  <span class="nl">labels:</span>
    <span class="nl">tier:</span> <span class="n">node</span>
    <span class="nl">app:</span> <span class="n">flannel</span>
<span class="nl">spec:</span>
  <span class="nl">template:</span>
    <span class="nl">metadata:</span>
      <span class="nl">labels:</span>
        <span class="nl">tier:</span> <span class="n">node</span>
        <span class="nl">app:</span> <span class="n">flannel</span>
    <span class="nl">spec:</span>
      <span class="nl">hostNetwork:</span> <span class="nb">true</span>
      <span class="nl">nodeSelector:</span>
        <span class="n">beta</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">arch</span><span class="o">:</span> <span class="n">amd64</span>
      <span class="nl">tolerations:</span>
      <span class="o">-</span> <span class="n">key</span><span class="o">:</span> <span class="n">node</span><span class="o">-</span><span class="n">role</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">master</span>
        <span class="nl">operator:</span> <span class="n">Exists</span>
        <span class="nl">effect:</span> <span class="n">NoSchedule</span>
      <span class="nl">serviceAccountName:</span> <span class="n">flannel</span>
      <span class="nl">initContainers:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">install</span><span class="o">-</span><span class="n">cni</span>
        <span class="nl">image:</span> <span class="n">registry</span><span class="p">.</span><span class="n">cn</span><span class="o">-</span><span class="n">hangzhou</span><span class="p">.</span><span class="n">aliyuncs</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">google</span><span class="o">-</span><span class="n">containers</span><span class="o">/</span><span class="n">flannel</span><span class="o">:</span><span class="n">v0</span><span class="mf">.9.0</span>
        <span class="nl">command:</span>
        <span class="o">-</span> <span class="n">cp</span>
        <span class="nl">args:</span>
        <span class="o">-</span> <span class="o">-</span><span class="n">f</span>
        <span class="o">-</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">flannel</span><span class="o">/</span><span class="n">cni</span><span class="o">-</span><span class="n">conf</span><span class="p">.</span><span class="n">json</span>
        <span class="o">-</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">cni</span><span class="o">/</span><span class="n">net</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="n">flannel</span><span class="p">.</span><span class="n">conf</span>
        <span class="nl">volumeMounts:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">cni</span>
          <span class="nl">mountPath:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">cni</span><span class="o">/</span><span class="n">net</span><span class="p">.</span><span class="n">d</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">flannel</span><span class="o">-</span><span class="n">cfg</span>
          <span class="nl">mountPath:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">flannel</span><span class="o">/</span>
      <span class="nl">containers:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">flannel</span>
        <span class="nl">image:</span> <span class="n">registry</span><span class="p">.</span><span class="n">cn</span><span class="o">-</span><span class="n">hangzhou</span><span class="p">.</span><span class="n">aliyuncs</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">google</span><span class="o">-</span><span class="n">containers</span><span class="o">/</span><span class="n">flannel</span><span class="o">:</span><span class="n">v0</span><span class="mf">.9.0</span>
        <span class="nl">command:</span>
        <span class="o">-</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">flanneld</span>
        <span class="nl">args:</span>
        <span class="o">-</span> <span class="o">--</span><span class="n">ip</span><span class="o">-</span><span class="n">masq</span>
        <span class="o">-</span> <span class="o">--</span><span class="n">kube</span><span class="o">-</span><span class="n">subnet</span><span class="o">-</span><span class="n">mgr</span>
        <span class="nl">resources:</span>
          <span class="nl">requests:</span>
            <span class="nl">cpu:</span> <span class="s">&quot;100m&quot;</span>
            <span class="nl">memory:</span> <span class="s">&quot;50Mi&quot;</span>
          <span class="nl">limits:</span>
            <span class="nl">cpu:</span> <span class="s">&quot;100m&quot;</span>
            <span class="nl">memory:</span> <span class="s">&quot;50Mi&quot;</span>
        <span class="nl">securityContext:</span>
          <span class="nl">privileged:</span> <span class="nb">true</span>
        <span class="nl">env:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">POD_NAME</span>
          <span class="nl">valueFrom:</span>
            <span class="nl">fieldRef:</span>
              <span class="nl">fieldPath:</span> <span class="n">metadata</span><span class="p">.</span><span class="n">name</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">POD_NAMESPACE</span>
          <span class="nl">valueFrom:</span>
            <span class="nl">fieldRef:</span>
              <span class="nl">fieldPath:</span> <span class="n">metadata</span><span class="p">.</span><span class="n">namespace</span>
        <span class="nl">volumeMounts:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">run</span>
          <span class="nl">mountPath:</span> <span class="o">/</span><span class="n">run</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">flannel</span><span class="o">-</span><span class="n">cfg</span>
          <span class="nl">mountPath:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">flannel</span><span class="o">/</span>
      <span class="nl">volumes:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">run</span>
          <span class="nl">hostPath:</span>
            <span class="nl">path:</span> <span class="o">/</span><span class="n">run</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">cni</span>
          <span class="nl">hostPath:</span>
            <span class="nl">path:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">cni</span><span class="o">/</span><span class="n">net</span><span class="p">.</span><span class="n">d</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">flannel</span><span class="o">-</span><span class="n">cfg</span>
          <span class="nl">configMap:</span>
            <span class="nl">name:</span> <span class="n">kube</span><span class="o">-</span><span class="n">flannel</span><span class="o">-</span><span class="n">cfg</span>
</pre></div>


<h2 id="15-worknode">1.5. Worknode 加入</h2>
<p>在worknode 上运行以下命令 加入集群</p>
<div class="hlcode"><pre><span class="n">kubeadm</span> <span class="n">join</span> <span class="mf">172.24.195.43</span><span class="o">:</span><span class="mi">6443</span> <span class="o">--</span><span class="n">token</span> <span class="n">bdibtv</span><span class="mf">.8</span><span class="n">iu07mfcpssfdrmg</span> \
    <span class="o">--</span><span class="n">discovery</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">hash</span> <span class="n">sha256</span><span class="o">:</span><span class="mi">6732957</span><span class="n">bd86580ac23b70bb7a1a0135149db580e3f25a7ce24c4c1409cd5b923</span>
</pre></div>


<p>kubeadm join 192.168.1.66:6443 --token 8wnr18.w4d1q0tybbyf02mv \<br />
    --discovery-token-ca-cert-hash sha256:4096879f382499fa82a935e7c10ded9c14fe56c155eef0b1170f2839d09489c5 </p>
<h2 id="16">1.6. 安装遇到的问题汇总</h2>
<h3 id="161-not-ready">1.6.1. not-ready</h3>
<div class="hlcode"><pre><span class="nl">https:</span><span class="c1">//stackoverflow.com/questions/47107117/how-to-debug-when-kubernetes-nodes-are-in-not-ready-state</span>
</pre></div>


<h2 id="17">1.7. 其他</h2>
<ol>
<li>kubelet会 自动重启<br />
The kubelet is now restarting every few seconds, as it waits in a crashloop for kubeadm to tell it what to do.</li>
</ol>
<div class="hlcode"><pre><span class="n">Environment</span><span class="o">=</span><span class="s">&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --cgroup-driver=cgroupfs&quot;</span>

<span class="n">systemctl</span> <span class="n">enable</span> <span class="n">kubelet</span><span class="p">.</span><span class="n">service</span>
<span class="n">systemctl</span> <span class="n">start</span> <span class="n">kubelet</span><span class="p">.</span><span class="n">service</span>
</pre></div>


<ol>
<li>配置 kubelet 的容器驱动</li>
</ol>
<p>当使用 <code>docker</code> 作为容器的时候， <code>kubeadm</code> 会自动检测 给以<code>kubelet</code>进程的Cgroup 驱动。相关设置在 <code>/var/lib/kubelet/kubeadm-flags.env</code></p>
<p>该文件会在执行  <code>kubeadm init</code> 和 <code>kubeadm join</code> 的时候使用</p>
<div class="hlcode"><pre><span class="n">cat</span> <span class="o">&lt;&lt;</span><span class="n">EOF</span> <span class="o">&gt;</span> <span class="n">rbac</span><span class="p">.</span><span class="n">yaml</span>
<span class="nl">apiVersion:</span> <span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1beta1</span>
<span class="nl">kind:</span> <span class="n">ClusterRoleBinding</span>
<span class="nl">metadata:</span>
  <span class="nl">name:</span> <span class="k">default</span><span class="o">-</span><span class="n">rbac</span>
<span class="nl">subjects:</span>
<span class="o">-</span> <span class="n">kind</span><span class="o">:</span> <span class="n">ServiceAccount</span>
  <span class="nl">name:</span> <span class="k">default</span>
  <span class="nl">namespace:</span> <span class="k">default</span>
<span class="nl">roleRef:</span>
  <span class="nl">kind:</span> <span class="n">ClusterRole</span>
  <span class="nl">name:</span> <span class="n">cluster</span><span class="o">-</span><span class="n">admin</span>
  <span class="nl">apiGroup:</span> <span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span>
<span class="n">EOF</span>

<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="o">:</span><span class="c1">//raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span>
<span class="n">helm</span> <span class="n">init</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">rbac</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="o">:</span><span class="c1">//raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml</span>
<span class="n">kubectl</span> <span class="n">create</span> <span class="n">clusterrolebinding</span> <span class="n">kubernetes</span><span class="o">-</span><span class="n">dashboard</span> <span class="o">--</span><span class="n">clusterrole</span><span class="o">=</span><span class="n">cluster</span><span class="o">-</span><span class="n">admin</span> <span class="o">--</span><span class="n">serviceaccount</span><span class="o">=</span><span class="n">kube</span><span class="o">-</span><span class="n">system</span><span class="o">:</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">dashboard</span>
</pre></div>


<h3 id="171-cgroups">1.7.1. 进程对硬件资源使用的限制(cgroups)</h3>
<p><code>Cgroup</code>是control group的简写，属于Linux内核提供的一个特性，用于限制和隔离一组进程对系统资源的使用，也就是做资源QoS，这些资源主要包括CPU、内存、block I/O和网络带宽。Cgroup从2.6.24开始进入内核主线，目前各大发行版都默认打开了Cgroup特性。<br />
Cgroups提供了以下四大功能:</p>
<ol>
<li>资源限制（Resource Limitation）：cgroups可以对进程组使用的资源总额进行限制。如设定应用运行时使用内存的上限，一旦超过这个配额就发出OOM（Out of Memory）。</li>
<li>优先级分配（Prioritization）：通过分配的CPU时间片数量及硬盘IO带宽大小，实际上就相当于控制了进程运行的优先级。</li>
<li>资源统计（Accounting）： cgroups可以统计系统的资源使用量，如CPU使用时长、内存用量等等，这个功能非常适用于计费。</li>
<li>进程控制（Control）：cgroups可以对进程组执行挂起、恢复等操作。</li>
</ol>
<p><img alt="" src="../../attach/images/2019-12-09-15-51-28.png" /></p>
<h1 id="_1">第三方管理安装工具</h1>
<p>推荐查阅<br />
https://github.com/easzlab/kubeasz</p>
<h1 id="2">2. 卸载</h1>
<div class="hlcode"><pre><span class="n">kubeadm</span> <span class="n">reset</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">purge</span> <span class="n">kubeadm</span> <span class="n">kubectl</span> <span class="n">kubelet</span> <span class="n">kubernetes</span><span class="o">-</span><span class="n">cni</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">autoremove</span>  
<span class="n">sudo</span> <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">~/</span><span class="p">.</span><span class="n">kube</span>
</pre></div>


<h1 id="kuberneters">公有云上部署 kuberneters</h1>
<p>公有云<br />
在公有云上使用kubeasz部署k8s集群需要注意以下几个常见问题。</p>
<p>安全组<br />
注意虚机的安全组规则配置，一般集群内部节点之间端口放开即可；</p>
<p>网络组件<br />
一般公有云对网络限制较多，跨节点 pod 通讯需要使用 OVERLAY 添加报头；比如可以使用如下：(kubeasz 项目中已默认配置)</p>
<p>flannel 使用 vxlan 模式：roles/flannel/defaults/main.yml<br />
calico 开启 ipinip：roles/calico/defaults/main.yml<br />
kube-router 开启 ipinip：roles/kube-router/defaults/main.yml<br />
节点公网访问<br />
可以在安装时每个节点绑定弹性公网地址(EIP)，装完集群解绑；也可以开通NAT网关，或者利用iptables自建上网网关等方式</p>
<p>负载均衡<br />
一般云厂商会限制使用keepalived+haproxy自建负载均衡，你可以根据云厂商文档使用云负载均衡（内网）四层TCP负载模式；</p>
<p>kubeasz 2x 版本已无需依赖外部负载均衡实现apiserver的高可用，详见 2x架构<br />
kubeasz 1x 及以前版本需要负载均衡实现apiserver高可用，详见 1x架构<br />
时间同步<br />
一般云厂商提供的虚机都已默认安装时间同步服务，无需自行安装。</p>
<p>访问 APISERVER<br />
在公有云上安装完集群后，需要在公网访问集群 apiserver，而我们在安装前可能没有规划公网IP或者公网域名；而 apiserver 肯定需要 https 方式访问，在证书创建时需要加入公网ip/域名；可以参考这里修改 APISERVER（MASTER）证书</p>
<p>在公有云上部署多主高可用集群<br />
处理好以上讨论的常见问题后，在公有云上使用 kubeasz 安装集群与自有环境没有差异。</p>
<p>使用 kubeasz 2x 版本安装单节点、单主多节点、多主多节点 k8s 集群，云上云下的预期安装体验完全一致</p>
</div>
<div id="renote">
  <HR style=" FILTER: alpha (opacity = 100, finishopacity =0 , style= 3 )" width="80%" color=#987 cb 9 SIZE=3>
  <p>如果你觉得这篇文章对你有帮助，不妨请我喝杯咖啡，鼓励我创造更多!</p>
  <img src="/Wiki/static/images/pay.jpg" width="25%">
</div>

    </div>
    <div id="footer">
        <span>
            Copyright © 2020 zhang787jun.
            Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
        </span>
    </div>

    
</body>
<script>
    function changeImgurl(site_root_url) {
        var images = document.images;
        var site_root = site_root_url;
        for (i = 0, len = images.length; i < len; i++) {
            image = images[i];
            image_src = image.src;
            if (image_src.search("attach") >= 0) {
                re_image_src = image_src.slice(image_src.search("attach"));
                abs_image_src = (site_root.endsWith("/")) ? site_root + re_image_src : site_root + "/" +
                    re_image_src;
                image.src = abs_image_src;
            }
        }
    }
    var site_root_url = "/Wiki";
    changeImgurl(site_root_url);
    let isMathjaxConfig = false; // 防止重复调用Config，造成性能损耗
    const initMathjaxConfig = () => {
        if (!window.MathJax) {
            return;
        }
        window.MathJax.Hub.Config({
            showProcessingMessages: false, //关闭js加载过程信息
            messageStyle: "none", //不显示信息
            jax: ["input/TeX", "output/HTML-CSS"],
            tex2jax: {
                inlineMath: [["$", "$"], ["\\(", "\\)"]], //行内公式选择符
                displayMath: [["$$", "$$"], ["\\[", "\\]"]], //段内公式选择符
                skipTags: ["script", "noscript", "style", "textarea", "pre", "code", "a"] //避开某些标签
            },
            "HTML-CSS": {
                availableFonts: ["STIX", "TeX"], //可选字体
                showMathMenu: false //关闭右击菜单显示
            }
        });
        isMathjaxConfig = true; //
    };
    if (isMathjaxConfig === false) {
        // 如果：没有配置MathJax
        initMathjaxConfig();
    };
</script>

</html>